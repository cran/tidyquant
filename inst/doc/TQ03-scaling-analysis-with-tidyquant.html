<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Matt Dancho" />

<meta name="date" content="2017-02-16" />

<title>Scaling Your Analysis with tidyquant</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Scaling Your Analysis with tidyquant</h1>
<h4 class="author"><em>Matt Dancho</em></h4>
<h4 class="date"><em>2017-02-16</em></h4>


<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#getting-financial-data-for-multiple-stocks">Getting Financial Data for Multiple Stocks</a><ul>
<li><a href="#method-1-map-a-character-vector-with-multiple-stock-symbols">Method 1: Map a character vector with multiple stock symbols</a></li>
<li><a href="#method-2-map-a-tibble-with-stocks-in-first-column">Method 2: Map a tibble with stocks in first column</a></li>
<li><a href="#method-3-use-purrr-to-map-a-function">Method 3: Use purrr to map a function</a></li>
<li><a href="#compound-getters">Compound Getters</a></li>
</ul></li>
<li><a href="#manipulating-financial-data-using-groups">Manipulating Financial Data using Groups</a></li>
<li><a href="#manipulating-financial-data-using-purrr">Manipulating Financial Data using purrr</a><ul>
<li><a href="#analyze-a-single-stock">Analyze a Single Stock</a></li>
<li><a href="#scale-to-many-stocks">Scale to Many Stocks</a></li>
</ul></li>
<li><a href="#error-handling-when-scaling">Error Handling when Scaling</a><ul>
<li><a href="#pros-and-cons-to-built-in-error-handling">Pros and Cons to Built-In Error-Handling</a></li>
<li><a href="#bad-apples-fail-gracefully-tq_get">Bad Apples Fail Gracefully, tq_get</a></li>
</ul></li>
</ul>
</div>

<blockquote>
<p>Designed to be used and scaled with the <code>tidyverse</code></p>
</blockquote>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p>The greatest benefit to <code>tidyquant</code> is the ability to easily scale your financial analysis. Scaling is the process of creating an analysis for one security and then extending it to multiple groups. This is idea of scaling is incredibly useful to financial analysts because typically one wants to compare many securities to make informed decisions. Fortunately, the <code>tidyquant</code> package integrates with the <code>tidyverse</code> making scaling super simple!</p>
<p>All <code>tidyquant</code> functions return data in the <code>tibble</code> (tidy data frame) format, which allows for interaction within the <code>tidyverse</code>. This means we can:</p>
<ul>
<li>Seamlessly scale data retrieval and transformations/mutations</li>
<li>Use the pipe (<code>%&gt;%</code>) for chaining operations</li>
<li>Use <code>dplyr</code> and <code>tidyr</code>: <code>select</code>, <code>filter</code>, <code>group_by</code>, <code>nest</code>/<code>unnest</code>, <code>spread</code>/<code>gather</code>, etc</li>
<li>Use <code>purrr</code>: mapping functions with <code>map</code></li>
</ul>
<p>We’ll go through some useful scaling techniques for getting and manipulating groups of data.</p>
</div>
<div id="prerequisites" class="section level1">
<h1>Prerequisites</h1>
<p>Load the <code>tidyquant</code> package to get started.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Loads tidyquant, tidyverse, lubridate, xts, quantmod, TTR </span>
<span class="kw">library</span>(tidyquant)  </code></pre></div>
</div>
<div id="getting-financial-data-for-multiple-stocks" class="section level1">
<h1>Getting Financial Data for Multiple Stocks</h1>
<p>A very basic example is retrieving the stock prices for multiple stocks. There are three primary ways to do this:</p>
<div id="method-1-map-a-character-vector-with-multiple-stock-symbols" class="section level2">
<h2>Method 1: Map a character vector with multiple stock symbols</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;FB&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2016-01-01&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2017-01-01&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 756 × 8
##    symbol       date   open   high    low  close   volume  adjusted
##     &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1    AAPL 2016-01-04 102.61 105.37 102.00 105.35 67649400 102.61218
## 2    AAPL 2016-01-05 105.75 105.85 102.41 102.71 55791000 100.04079
## 3    AAPL 2016-01-06 100.56 102.37  99.87 100.70 68457400  98.08303
## 4    AAPL 2016-01-07  98.68 100.13  96.43  96.45 81094400  93.94347
## 5    AAPL 2016-01-08  98.55  99.11  96.76  96.96 70798000  94.44022
## 6    AAPL 2016-01-11  98.97  99.06  97.34  98.53 49739400  95.96942
## 7    AAPL 2016-01-12 100.55 100.69  98.84  99.96 49154200  97.36226
## 8    AAPL 2016-01-13 100.32 101.19  97.30  97.39 62439600  94.85905
## 9    AAPL 2016-01-14  97.96 100.48  95.74  99.52 63170100  96.93369
## 10   AAPL 2016-01-15  96.20  97.71  95.36  97.13 79010000  94.60580
## # ... with 746 more rows</code></pre>
<p>The output is a single level tibble with all or the stock prices in one tibble. The auto-generated column name is “symbol”, which can be pre-emptively renamed by giving the vector a name (e.g. <code>stocks &lt;- c(&quot;AAPL&quot;, &quot;GOOG&quot;, &quot;FB&quot;)</code>) and then piping to <code>tq_get</code>.</p>
</div>
<div id="method-2-map-a-tibble-with-stocks-in-first-column" class="section level2">
<h2>Method 2: Map a tibble with stocks in first column</h2>
<p>First, get a stock list in data frame format either by making the tibble or retrieving from <code>tq_index</code> / <code>tq_exchange</code>. The stock symbols must be in the first column.</p>
<div id="method-2a-make-a-tibble" class="section level3">
<h3>Method 2A: Make a tibble</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">stocks =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;JPM&quot;</span>, <span class="st">&quot;CVX&quot;</span>),
                     <span class="dt">industry =</span> <span class="kw">c</span>(<span class="st">&quot;Technology&quot;</span>, <span class="st">&quot;Financial&quot;</span>, <span class="st">&quot;Energy&quot;</span>))
stock_list</code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   stocks   industry
##    &lt;chr&gt;      &lt;chr&gt;
## 1   AAPL Technology
## 2    JPM  Financial
## 3    CVX     Energy</code></pre>
<p>Second, send the stock list to <code>tq_get</code>. Notice how the symbol and industry columns are automatically expanded the length of the stock prices.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2016-01-01&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2017-01-01&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 756 × 9
##    stocks   industry       date   open   high    low  close   volume
##     &lt;chr&gt;      &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1    AAPL Technology 2016-01-04 102.61 105.37 102.00 105.35 67649400
## 2    AAPL Technology 2016-01-05 105.75 105.85 102.41 102.71 55791000
## 3    AAPL Technology 2016-01-06 100.56 102.37  99.87 100.70 68457400
## 4    AAPL Technology 2016-01-07  98.68 100.13  96.43  96.45 81094400
## 5    AAPL Technology 2016-01-08  98.55  99.11  96.76  96.96 70798000
## 6    AAPL Technology 2016-01-11  98.97  99.06  97.34  98.53 49739400
## 7    AAPL Technology 2016-01-12 100.55 100.69  98.84  99.96 49154200
## 8    AAPL Technology 2016-01-13 100.32 101.19  97.30  97.39 62439600
## 9    AAPL Technology 2016-01-14  97.96 100.48  95.74  99.52 63170100
## 10   AAPL Technology 2016-01-15  96.20  97.71  95.36  97.13 79010000
## # ... with 746 more rows, and 1 more variables: adjusted &lt;dbl&gt;</code></pre>
</div>
<div id="method-2b-use-index-or-exchange" class="section level3">
<h3>Method 2B: Use index or exchange</h3>
<p>Get an index…</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_index</span>(<span class="st">&quot;DOWJONES&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 65 × 2
##    symbol                      company
##     &lt;chr&gt;                        &lt;chr&gt;
## 1     MMM                           3M
## 2     ALK             ALASKA AIR GROUP
## 3     AAL AMERICAN AIRLINES GROUP INC.
## 4     AEP      AMERICAN ELECTRIC POWER
## 5     AXP             AMERICAN EXPRESS
## 6     AWK         AMERICAN WATER WORKS
## 7    AAPL                        APPLE
## 8     CAR            AVIS BUDGET GROUP
## 9     CAT                  CATERPILLAR
## 10    CNP           CENTERPOINT ENERGY
## # ... with 55 more rows</code></pre>
<p>…or, get an exchange.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_exchange</span>(<span class="st">&quot;NYSE&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 3,161 × 7
##    symbol                company last.sale.price market.cap ipo.year
##     &lt;chr&gt;                  &lt;chr&gt;           &lt;dbl&gt;      &lt;chr&gt;    &lt;dbl&gt;
## 1     DDD 3D Systems Corporation           16.92      $1.9B       NA
## 2     MMM             3M Company          183.41   $109.35B       NA
## 3    WBAI        500.com Limited           13.14   $545.28M     2013
## 4    WUBA            58.com Inc.           33.70     $4.88B     2013
## 5     AHC  A.H. Belo Corporation            6.40   $138.73M       NA
## 6    ATEN     A10 Networks, Inc.            9.76   $655.93M     2014
## 7     AAC     AAC Holdings, Inc.            8.06   $191.08M     2014
## 8     AIR              AAR Corp.           33.95     $1.17B       NA
## 9     AAN     Aaron&amp;#39;s,  Inc.           29.52     $2.14B       NA
## 10    ABB                ABB Ltd           23.01    $49.15B       NA
## # ... with 3,151 more rows, and 2 more variables: sector &lt;chr&gt;,
## #   industry &lt;chr&gt;</code></pre>
<p>Send the index or exchange to <code>tq_get</code>. <em>Important Note: This can take several minutes depending on the size of the index or exchange, which is why only the first three stocks are evaluated in the vignette.</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_index</span>(<span class="st">&quot;DOWJONES&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">slice</span>(<span class="dv">1</span>:<span class="dv">3</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 7,650 × 9
##    symbol company       date  open  high   low close  volume adjusted
##     &lt;chr&gt;   &lt;chr&gt;     &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
## 1     MMM      3M 2007-01-03 77.53 78.85 77.38 78.26 3781500 59.92042
## 2     MMM      3M 2007-01-04 78.40 78.41 77.45 77.95 2968400 59.68306
## 3     MMM      3M 2007-01-05 77.89 77.90 77.01 77.42 2765200 59.27726
## 4     MMM      3M 2007-01-08 77.42 78.04 76.97 77.59 2434500 59.40742
## 5     MMM      3M 2007-01-09 78.00 78.23 77.44 77.68 1896800 59.47633
## 6     MMM      3M 2007-01-10 77.31 77.96 77.04 77.85 1787500 59.60649
## 7     MMM      3M 2007-01-11 78.05 79.03 77.88 78.65 2372500 60.21902
## 8     MMM      3M 2007-01-12 78.41 79.50 78.22 79.36 2582200 60.76264
## 9     MMM      3M 2007-01-16 79.48 79.62 78.92 79.56 2526600 60.91577
## 10    MMM      3M 2007-01-17 79.33 79.51 78.75 78.91 2711300 60.41810
## # ... with 7,640 more rows</code></pre>
<p>You can use any applicable “getter” to get data for <strong>every stock in an index or an exchange</strong>! This includes: “stock.prices”, “key.ratios”, “key.stats”, “financials”, and more.</p>
</div>
</div>
<div id="method-3-use-purrr-to-map-a-function" class="section level2">
<h2>Method 3: Use purrr to map a function</h2>
<p>We can pipe a tibble of stock symbols to a mutation that maps the <code>tq_get(get = &quot;stock.prices&quot;)</code> function. The result is all of the stock prices in nested format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tibble</span>(<span class="dt">symbol =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;AMZN&quot;</span>, <span class="st">&quot;FB&quot;</span>)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">stock.prices =</span> <span class="kw">map</span>(<span class="dt">.x =</span> symbol, ~<span class="st"> </span><span class="kw">tq_get</span>(.x, <span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)))</code></pre></div>
<pre><code>## # A tibble: 4 × 2
##   symbol         stock.prices
##    &lt;chr&gt;               &lt;list&gt;
## 1   AAPL &lt;tibble [2,550 × 7]&gt;
## 2   GOOG &lt;tibble [2,550 × 7]&gt;
## 3   AMZN &lt;tibble [2,550 × 7]&gt;
## 4     FB &lt;tibble [1,195 × 7]&gt;</code></pre>
</div>
<div id="compound-getters" class="section level2">
<h2>Compound Getters</h2>
<p>In financial analysis, it’s very common to need data from various sources to combine in an analysis. For this reason multiple <code>get</code> options (“compound getters”) can be used to return a “compound get”. A quick example:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="kw">c</span>(<span class="st">&quot;stock.prices&quot;</span>, <span class="st">&quot;financials&quot;</span>))</code></pre></div>
<pre><code>## # A tibble: 2 × 3
##   symbol         stock.prices       financials
##    &lt;chr&gt;               &lt;list&gt;           &lt;list&gt;
## 1   AAPL &lt;tibble [2,550 × 7]&gt; &lt;tibble [3 × 3]&gt;
## 2   GOOG &lt;tibble [2,550 × 7]&gt; &lt;tibble [3 × 3]&gt;</code></pre>
<p>This returns the stock prices and financials for each stock as one nested data frame! Any of the <code>get</code> options that accept stock symbols can be used in this manner: <code>&quot;stock.prices&quot;</code>, <code>&quot;financials&quot;</code>, <code>&quot;key.ratios&quot;</code>, <code>&quot;key.stats&quot;</code>, <code>&quot;dividends&quot;</code>, and <code>&quot;splits&quot;</code>.</p>
<p>This capability becomes incredibly useful when combined with <code>purrr</code> function mapping, which is discussed in <a href="#purrr-function-mapping">Manipulating Financial Data with purrr</a>.</p>
</div>
</div>
<div id="manipulating-financial-data-using-groups" class="section level1">
<h1>Manipulating Financial Data using Groups</h1>
<p>Once you get the data, you typically want to do something with it. You can easily do this at scale. Let’s get the yearly returns for multiple stocks using <code>tq_transform</code>. First, get the prices. Second, use <code>group_by</code> to group by stock symbol. Third, apply the transformation. We can do this in one easy workflow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;FB&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2012-01-01&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2017-01-01&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(symbol) %&gt;%
<span class="st">    </span><span class="kw">tq_transform</span>(Ad, <span class="dt">transform_fun =</span> periodReturn, <span class="dt">period =</span> <span class="st">&quot;yearly&quot;</span>, 
                 <span class="dt">col_rename =</span> <span class="st">&quot;yearly.returns&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> <span class="kw">year</span>(date), <span class="dt">y =</span> yearly.returns, <span class="dt">fill =</span> symbol)) +
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>, <span class="dt">stat =</span> <span class="st">&quot;identity&quot;</span>) +
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::percent) +
<span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">2008</span>, <span class="dv">2017</span>, <span class="dt">by =</span> <span class="dv">1</span>)) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AAPL, GOOG, FB: Annual Returns&quot;</span>, 
         <span class="dt">subtitle =</span> <span class="st">&quot;Transforming using quantmod functions is easy!&quot;</span>, 
         <span class="dt">x =</span> <span class="st">&quot;&quot;</span>) +
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&quot;bottom&quot;</span>)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p><a class="anchor" id="purrr-function-mapping"></a></p>
</div>
<div id="manipulating-financial-data-using-purrr" class="section level1">
<h1>Manipulating Financial Data using purrr</h1>
<p>Eventually you will want to begin modeling at scale! One of the <strong>best</strong> features of the <code>tidyverse</code> is the ability to map functions to nested tibbles using <code>purrr</code>. From the Many Models chapter of “<a href="http://r4ds.had.co.nz/">R for Data Science</a>”, we can apply the same modeling workflow to financial analysis. Using a two step workflow:</p>
<ol style="list-style-type: decimal">
<li>Analyze a single stock</li>
<li>Scale to many stocks</li>
</ol>
<p>Let’s go through an example to illustrate. In our hypothetical situation, we want to compare the mean monthly log returns (MMLR).</p>
<div id="analyze-a-single-stock" class="section level2">
<h2>Analyze a Single Stock</h2>
<p>First, let’s come up with a function to help us collect log returns. The function below performs three operations internally. It first gets the stock prices using <code>tq_get()</code>. Then, it transforms the stock prices to period returns using <code>tq_transform()</code>. We add the <code>type = &quot;log&quot;</code> and <code>period = &quot;monthly&quot;</code> arguments to ensure we retrieve a tibble of monthly log returns. Last, we take the mean of the monthly returns to get MMLR.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_stock_analysis_fun &lt;-<span class="st"> </span>function(stock.symbol) {
    period.returns &lt;-<span class="st"> </span>stock.symbol %&gt;%
<span class="st">        </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>) %&gt;%
<span class="st">        </span><span class="kw">tq_transform</span>(<span class="dt">ohlc_fun =</span> Ad, <span class="dt">transform_fun =</span> periodReturn, 
                     <span class="dt">type =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">period =</span> <span class="st">&quot;monthly&quot;</span>)
    <span class="kw">mean</span>(period.returns$monthly.returns)
}</code></pre></div>
<p>And, let’s test it out. We now have the mean monthly log returns over the past ten years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_stock_analysis_fun</span>(<span class="st">&quot;AAPL&quot;</span>)</code></pre></div>
<pre><code>## [1] 0.0206807</code></pre>
</div>
<div id="scale-to-many-stocks" class="section level2">
<h2>Scale to Many Stocks</h2>
<p>Now that we have one stock down, we can scale to many stocks. For brevity, we’ll randomly sample ten stocks from the S&amp;P500 with a call to <code>dplyr::sample_n()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">100</span>)
stocks &lt;-<span class="st"> </span><span class="kw">tq_index</span>(<span class="st">&quot;SP500&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">sample_n</span>(<span class="dv">10</span>)
stocks</code></pre></div>
<pre><code>## # A tibble: 10 × 2
##    symbol             company
##     &lt;chr&gt;               &lt;chr&gt;
## 1     EMC                 EMC
## 2     DVN        DEVON ENERGY
## 3     MNK    MALLINCKRODT PLC
## 4     AIG       AMERICAN INTL
## 5    INTC               INTEL
## 6     IVZ             INVESCO
## 7     SWN SOUTHWESTERN ENERGY
## 8     FLS           FLOWSERVE
## 9     LMT     LOCKHEED MARTIN
## 10    CNP  CENTERPOINT ENERGY</code></pre>
<p>We can now apply our analysis function to the stocks using <code>dplyr::mutate</code> and <code>purrr::map_dbl</code>. The <code>mutate()</code> function adds a column to our tibble, and the <code>map_dbl()</code> function maps our <code>my_stock_analysis_fun</code> to our tibble of stocks using the <code>symbol</code> column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stocks &lt;-<span class="st"> </span>stocks %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">mmlr =</span> <span class="kw">map_dbl</span>(symbol, my_stock_analysis_fun)) %&gt;%
<span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(mmlr))
stocks</code></pre></div>
<pre><code>## # A tibble: 10 × 3
##    symbol             company         mmlr
##     &lt;chr&gt;               &lt;chr&gt;        &lt;dbl&gt;
## 1     LMT     LOCKHEED MARTIN  0.011325008
## 2     FLS           FLOWSERVE  0.009926539
## 3     CNP  CENTERPOINT ENERGY  0.007445493
## 4    INTC               INTEL  0.007381266
## 5     EMC                 EMC  0.007208655
## 6     IVZ             INVESCO  0.004901501
## 7     MNK    MALLINCKRODT PLC  0.003425571
## 8     DVN        DEVON ENERGY -0.002154825
## 9     SWN SOUTHWESTERN ENERGY -0.005299089
## 10    AIG       AMERICAN INTL -0.023569531</code></pre>
<p>And, we’re done! We now have the MMLR for 10-years of stock data for 10 stocks. And, we can easily extend this to larger lists or stock indexes. For example, the entire S&amp;P500 could be analyzed removing the <code>sample_n()</code> following the call to <code>tq_index(&quot;SP500&quot;)</code>.</p>
</div>
</div>
<div id="error-handling-when-scaling" class="section level1">
<h1>Error Handling when Scaling</h1>
<p>Eventually you will run into a stock index, stock symbol, FRED data code, etc that cannot be retrieved. Possible reasons are:</p>
<ul>
<li>An index becomes out of date</li>
<li>A company goes private</li>
<li>A stock ticker symbol changes</li>
<li>Yahoo / FRED just doesn’t like your stock symbol / FRED code</li>
</ul>
<p>This becomes painful when scaling if the functions return errors. So, the <code>tq_get()</code> function is designed to handle errors <em>gracefully</em>. What this means is an <code>NA</code> value is returned when an error is generated along with a <em>gentle error warning</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_get</span>(<span class="st">&quot;XYZ&quot;</span>, <span class="st">&quot;stock.prices&quot;</span>)</code></pre></div>
<pre><code>## [1] NA</code></pre>
<div id="pros-and-cons-to-built-in-error-handling" class="section level2">
<h2>Pros and Cons to Built-In Error-Handling</h2>
<p>There are pros and cons to this approach that you may not agree with, but I believe helps in the long run. Just be aware of what happens:</p>
<ul>
<li><p><strong>Pros</strong>: Long running scripts are not interrupted because of one error</p></li>
<li><p><strong>Cons</strong>: Errors can be inadvertently handled or flow downstream if the users does not read the warnings</p></li>
</ul>
</div>
<div id="bad-apples-fail-gracefully-tq_get" class="section level2">
<h2>Bad Apples Fail Gracefully, tq_get</h2>
<p>Let’s see an example when using <code>tq_get()</code> to get the stock prices for a long list of stocks with one <code>BAD APPLE</code>. The argument <code>complete_cases</code> comes in handy. The default is <code>TRUE</code>, which removes “bad apples” so future analysis have complete cases to compute on. Note that a gentle warning stating that an error occurred and was dealt with by removing the rows from the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;BAD APPLE&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">complete_cases =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Warning in value[[3L]](cond): Error at BAD APPLE during call to get =
## 'stock.prices'. Removing BAD APPLE.</code></pre>
<pre><code>## # A tibble: 5,100 × 8
##    symbol       date  open  high   low close    volume adjusted
##     &lt;chr&gt;     &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1    AAPL 2007-01-03 86.29 86.58 81.90 83.80 309579900 10.85709
## 2    AAPL 2007-01-04 84.05 85.95 83.82 85.66 211815100 11.09807
## 3    AAPL 2007-01-05 85.77 86.20 84.40 85.05 208685400 11.01904
## 4    AAPL 2007-01-08 85.96 86.53 85.28 85.47 199276700 11.07345
## 5    AAPL 2007-01-09 86.45 92.98 85.15 92.57 837324600 11.99333
## 6    AAPL 2007-01-10 94.75 97.80 93.45 97.00 738220000 12.56728
## 7    AAPL 2007-01-11 95.94 96.78 95.10 95.80 360063200 12.41180
## 8    AAPL 2007-01-12 94.59 95.06 93.23 94.62 328172600 12.25892
## 9    AAPL 2007-01-16 95.68 97.25 95.45 97.10 311019100 12.58023
## 10   AAPL 2007-01-17 97.56 97.60 94.82 94.95 411565000 12.30168
## # ... with 5,090 more rows</code></pre>
<p>Now switching <code>complete_cases = FALSE</code> will retain any errors as <code>NA</code> values in a nested data frame. Notice that the error message and output change. The error message now states that the <code>NA</code> values exist in the output and the return is a “nested” data structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;BAD APPLE&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">complete_cases =</span> <span class="ot">FALSE</span>)</code></pre></div>
<pre><code>## Warning in value[[3L]](cond): Error at BAD APPLE during call to get =
## 'stock.prices'.</code></pre>
<pre><code>## Warning in value[[3L]](cond): Returning as nested data frame.</code></pre>
<pre><code>## # A tibble: 3 × 2
##      symbol         stock.prices
##       &lt;chr&gt;               &lt;list&gt;
## 1      AAPL &lt;tibble [2,550 × 7]&gt;
## 2      GOOG &lt;tibble [2,550 × 7]&gt;
## 3 BAD APPLE            &lt;lgl [1]&gt;</code></pre>
<p>In both cases, the prudent user will review the warnings to determine what happened and whether or not this is acceptable. In the <code>complete_cases = FALSE</code> example, if the user attempts to perform downstream computations at scale, the computations will likely fail grinding the analysis to a hault. But, the advantage is that the user will more easily be able to filter to the problem childs to determine what happened and decide whether this is acceptable or not.</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
