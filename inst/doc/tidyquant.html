<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Matt Dancho" />

<meta name="date" content="2017-01-21" />

<title>Introduction to tidyquant</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Introduction to tidyquant</h1>
<h4 class="author"><em>Matt Dancho</em></h4>
<h4 class="date"><em>2017-01-21</em></h4>


<div id="TOC">
<ul>
<li><a href="#overview">Overview</a></li>
<li><a href="#prerequisites">Prerequisites</a></li>
<li><a href="#benefits">Benefits</a><ul>
<li><a href="#a-few-core-functions-with-a-lot-of-power">A Few Core Functions with A Lot of Power</a></li>
<li><a href="#work-in-the-tidyverse">Work in the tidyverse</a></li>
<li><a href="#leverage-the-quantitative-power-of-xts-quantmod-and-ttr">Leverage the Quantitative Power of xts, quantmod and TTR</a></li>
<li><a href="#designed-to-be-scaled-with-the-tidyverse">Designed to be Scaled with the tidyverse</a></li>
</ul></li>
<li><a href="#recap">Recap</a></li>
</ul>
</div>

<blockquote>
<p>Bringing financial analysis to the tidyverse</p>
</blockquote>
<div id="overview" class="section level1">
<h1>Overview</h1>
<p><code>tidyquant</code> integrates the best quantitative resources for collecting and analyzing quantitative data, <code>xts</code> and <code>zoo</code>, <code>quantmod</code> and <code>TTR</code>, with the tidy data infrastructure of the <code>tidyverse</code> allowing for seamless interaction between each and working within the <code>tidyverse</code>.</p>
<p>The three primary quantitative packages that are the backbone for quantitative financial analysis in <em>R programming</em> are:</p>
<ul>
<li><a href="https://CRAN.R-project.org/package=xts">xts</a>, or <a href="http://joshuaulrich.github.io/xts/index.html">eXtensible time series</a>: The data structure for handling time-series data. The underlying time-series structure is <code>zoo</code>, which is also integrated.</li>
<li><a href="https://CRAN.R-project.org/package=quantmod">quantmod</a>, or <a href="http://www.quantmod.com/">Quantitative Financial Modelling &amp; Trading Framework for R</a>: A package designed for retrieving, manipulating, and modeling and quantitative data.</li>
<li><a href="https://CRAN.R-project.org/package=TTR">TTR</a>, or Technical Trading Rules: A package that includes various functions to compute technical trading equations for quantitative or trading data.</li>
</ul>
<p>The <a href="https://www.jstatsoft.org/article/view/v059i10">tidy data principles</a> are a cornerstone of data management and data modeling workflow. The foundation for tidy data management is the <code>tidyverse</code>, a collection of <em>R packages</em>: <code>ggplot2</code>, <code>dplyr</code>, <code>tidyr</code>, <code>purrr</code>, <code>readr</code>, <code>tibble</code>, that work in harmony, are built for scalability, and are well documented in <a href="http://r4ds.had.co.nz/">R for Data Science</a>. Using this infrastructure and the core tidy concepts, we can integrate the tidy data principles with the best quantitative financial analysis packages using the package, <code>tidyquant</code>.</p>
</div>
<div id="prerequisites" class="section level1">
<h1>Prerequisites</h1>
<p>Load the <code>tidyquant</code> package to get started.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Loads tidyquant, tidyverse, lubridate, xts, quantmod, TTR </span>
<span class="kw">library</span>(tidyquant)  </code></pre></div>
</div>
<div id="benefits" class="section level1">
<h1>Benefits</h1>
<p><strong>The <code>tidyquant</code> philosophy</strong>:</p>
<ul>
<li><strong>A few core functions with a lot of power, that</strong></li>
<li><strong>leverage the quantitative analysis power of <code>xts</code>, <code>quantmod</code> and <code>TTR</code>, and are</strong></li>
<li><strong>designed to be used and scaled with the <code>tidyverse</code>.</strong></li>
</ul>
<p><a class="anchor" id="core-functions"></a></p>
<div id="a-few-core-functions-with-a-lot-of-power" class="section level2">
<h2>A Few Core Functions with A Lot of Power</h2>
<p>Minimizing the number of functions reduces the learning curve. Functions are grouped into verbs for efficient collection and manipulation of quantitative data:</p>
<ul>
<li><p><strong>Get Quantitative Data, <code>tq_get()</code></strong>: A one-stop shop to get data from various web-sources.</p></li>
<li><p><strong>Transform, <code>tq_transform()</code>, and Mutate, <code>tq_mutate()</code>, Quantitative Data</strong>: These are the workhorse functions that wrap around the <code>xts</code>, <code>quantmod</code>, and <code>TTR</code> packages.</p></li>
<li><p><strong>Coerce Quantitative Data Between tibble and xts formats, <code>as_tibble()</code> and <code>as_xts()</code></strong>: Coercing <code>xts</code>, <code>zoo</code>, <code>timeSeries</code>, and the other various <em>R</em> time-based objects to and from <code>tibble</code> or <code>data.frame</code> objects was a pain due to the date/time being stored as row names in time-based objects. The tidyquant <code>as_tibble()</code> and <code>as_xts()</code> functions enable preservation of row names during coercion.</p></li>
</ul>
<p><a class="anchor" id="tq-get"></a></p>
<div id="get-quantitative-data" class="section level3">
<h3>Get Quantitative Data</h3>
<p>The <code>tq_get()</code> function is used to collect all data by changing the <code>get</code> argument. The options include stock lists for 18 stock indexes from marketvolume.com, stock prices, dividends and splits from Yahoo Finance, financial statements from Google Finance, metal prices and exchange rates from Oanda, and economic data from the FRED database. To see the full list, execute <code>tq_get_options()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_get_options</span>()</code></pre></div>
<pre><code>##  [1] &quot;stock.prices&quot;   &quot;stock.index&quot;    &quot;financials&quot;     &quot;key.stats&quot;     
##  [5] &quot;key.ratios&quot;     &quot;dividends&quot;      &quot;splits&quot;         &quot;economic.data&quot; 
##  [9] &quot;exchange.rates&quot; &quot;metal.prices&quot;</code></pre>
<p><strong>Stock Index</strong>:</p>
<p>A wide range of stock index / exchange lists can be retrieved using <code>get = &quot;stock.index&quot;</code>. To get a full list of the options, use <code>tq_get_stock_index_options()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_get_stock_index_options</span>()</code></pre></div>
<pre><code>##  [1] &quot;DOWJONES&quot;    &quot;DJI&quot;         &quot;DJT&quot;         &quot;DJU&quot;         &quot;SP100&quot;      
##  [6] &quot;SP400&quot;       &quot;SP500&quot;       &quot;SP600&quot;       &quot;RUSSELL1000&quot; &quot;RUSSELL2000&quot;
## [11] &quot;RUSSELL3000&quot; &quot;AMEX&quot;        &quot;AMEXGOLD&quot;    &quot;AMEXOIL&quot;     &quot;NASDAQ&quot;     
## [16] &quot;NASDAQ100&quot;   &quot;NYSE&quot;        &quot;SOX&quot;</code></pre>
<p>Set <code>x</code> as one of the options in the list of options above, and <code>get = &quot;stock.index&quot;</code> to get the desired stock index / exchange.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_get</span>(<span class="st">&quot;sp500&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;stock.index&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 501 × 2
##    symbol                   company
##     &lt;chr&gt;                     &lt;chr&gt;
## 1     MMM                        3M
## 2     ABT       ABBOTT LABORATORIES
## 3    ABBV                ABBVIE INC
## 4     ACN                 ACCENTURE
## 5    ATVI       ACTIVISION BLIZZARD
## 6     AYI             ACUITY BRANDS
## 7    ADBE             ADOBE SYSTEMS
## 8     AAP        ADVANCE AUTO PARTS
## 9     AET                     AETNA
## 10    AMG AFFILIATED MANAGERS GROUP
## # ... with 491 more rows</code></pre>
<p>The data source is <a href="http://www.marketvolume.com/indexes_exchanges/">www.marketvolume.com</a>.</p>
<p><strong>Stock Prices, Dividends and Splits</strong>:</p>
<p>The stock prices can be retrieved succinctly using <code>get = &quot;stock.prices&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_prices  &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot; 1990-01-01&quot;</span>)
aapl_prices </code></pre></div>
<pre><code>## # A tibble: 6,818 × 7
##          date   open   high   low  close   volume adjusted
##        &lt;date&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1  1990-01-02 35.250 37.500 35.00 37.250 45799600 1.132075
## 2  1990-01-03 38.000 38.000 37.50 37.500 51998800 1.139673
## 3  1990-01-04 38.250 38.750 37.25 37.625 55378400 1.143471
## 4  1990-01-05 37.750 38.250 37.00 37.750 30828000 1.147270
## 5  1990-01-08 37.500 38.000 37.00 38.000 25393200 1.154868
## 6  1990-01-09 38.000 38.000 37.00 37.625 21534800 1.143471
## 7  1990-01-10 37.625 37.625 35.75 36.000 49929600 1.094086
## 8  1990-01-11 36.250 36.250 34.50 34.500 52763200 1.048499
## 9  1990-01-12 34.250 34.750 33.75 34.500 42974400 1.048499
## 10 1990-01-15 34.500 35.750 34.25 34.250 40434800 1.040901
## # ... with 6,808 more rows</code></pre>
<p>Dividends are obtained using <code>get = &quot;dividends&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_divs &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;dividends&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;1990-01-01&quot;</span>)
aapl_divs</code></pre></div>
<pre><code>## # A tibble: 42 × 2
##          date dividends
##        &lt;date&gt;     &lt;dbl&gt;
## 1  1990-02-16   0.00393
## 2  1990-05-21   0.00393
## 3  1990-08-20   0.00393
## 4  1990-11-16   0.00429
## 5  1991-02-15   0.00429
## 6  1991-05-20   0.00429
## 7  1991-08-19   0.00429
## 8  1991-11-18   0.00429
## 9  1992-02-14   0.00429
## 10 1992-06-01   0.00429
## # ... with 32 more rows</code></pre>
<p>Stock splits are obtained using <code>get = &quot;splits&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_splits &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;splits&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;1990-01-01&quot;</span>)
aapl_splits</code></pre></div>
<pre><code>## # A tibble: 3 × 2
##         date    splits
##       &lt;date&gt;     &lt;dbl&gt;
## 1 2000-06-21 0.5000000
## 2 2005-02-28 0.5000000
## 3 2014-06-09 0.1428571</code></pre>
<p>The data source is <a href="https://finance.yahoo.com/">Yahoo Finance</a>.</p>
<p><strong>Financial Statements</strong>:</p>
<p>For any given stock, a total of six financials statements are retrieved as nested tibbles, one for each combination of statement type (Income Statement, Balance Sheet, and Cash Flow) and period (by annual and quarter).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_financials &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;financials&quot;</span>)
aapl_financials</code></pre></div>
<pre><code>## # A tibble: 3 × 3
##    type             annual            quarter
## * &lt;chr&gt;             &lt;list&gt;             &lt;list&gt;
## 1    BS &lt;tibble [168 × 4]&gt; &lt;tibble [210 × 4]&gt;
## 2    CF  &lt;tibble [76 × 4]&gt;  &lt;tibble [76 × 4]&gt;
## 3    IS &lt;tibble [196 × 4]&gt; &lt;tibble [245 × 4]&gt;</code></pre>
<p>The statement information can be extracted by selecting (<code>dplyr::select()</code>) and filtering (<code>dplyr::filter()</code>) to the desired statement and unnesting (<code>tidyr::unnest()</code>) the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_financials %&gt;%
<span class="st">    </span><span class="kw">filter</span>(type ==<span class="st"> &quot;IS&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(annual) %&gt;%
<span class="st">    </span><span class="kw">unnest</span>()</code></pre></div>
<pre><code>## # A tibble: 196 × 4
##    group             category       date  value
##    &lt;int&gt;                &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;
## 1      1              Revenue 2016-09-24 215639
## 2      1              Revenue 2015-09-26 233715
## 3      1              Revenue 2014-09-27 182795
## 4      1              Revenue 2013-09-28 170910
## 5      2 Other Revenue, Total 2016-09-24     NA
## 6      2 Other Revenue, Total 2015-09-26     NA
## 7      2 Other Revenue, Total 2014-09-27     NA
## 8      2 Other Revenue, Total 2013-09-28     NA
## 9      3        Total Revenue 2016-09-24 215639
## 10     3        Total Revenue 2015-09-26 233715
## # ... with 186 more rows</code></pre>
<p>A slightly more powerful example is looking at all quarterly statements together. This is easy to do with <code>unnest</code> and <code>spread</code> from the <code>tidyr</code> package.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_financials %&gt;%
<span class="st">    </span><span class="kw">unnest</span>(quarter) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">spread</span>(<span class="dt">key =</span> date, <span class="dt">value =</span> value)</code></pre></div>
<pre><code>## # A tibble: 110 × 8
##     type group                         category `2015-09-26` `2015-12-26`
## *  &lt;chr&gt; &lt;int&gt;                            &lt;chr&gt;        &lt;dbl&gt;        &lt;dbl&gt;
## 1     BS     1               Cash &amp; Equivalents         9731         5537
## 2     BS     2           Short Term Investments        20590        21660
## 3     BS     3  Cash and Short Term Investments        41710        38349
## 4     BS     4 Accounts Receivable - Trade, Net        16849        12953
## 5     BS     5              Receivables - Other           NA           NA
## 6     BS     6           Total Receivables, Net        30343        24621
## 7     BS     7                  Total Inventory         2349         2451
## 8     BS     8                 Prepaid Expenses           NA           NA
## 9     BS     9      Other Current Assets, Total        14976        10798
## 10    BS    10             Total Current Assets        89378        76219
## # ... with 100 more rows, and 3 more variables: `2016-03-26` &lt;dbl&gt;,
## #   `2016-06-25` &lt;dbl&gt;, `2016-09-24` &lt;dbl&gt;</code></pre>
<p>The data source is <a href="https://www.google.com/finance">Google Finance</a>.</p>
<p><strong>Key Ratios</strong>:</p>
<p>For any given stock, the historical key ratios are available for 10 years, and are classified into the following sections:</p>
<ul>
<li><strong>Financials</strong>: These ratios include gross margin %, operating margin %, EPS, book value per share, and more.</li>
<li><strong>Profitability</strong>: These ratios include margin as a percentage of sales (gross margin, operating margin, EBT margin, etc) and profitability metrics such as tax rate %, asset turnover, ROA, financial leverage, ROE, return on invested capital, and more.</li>
<li><strong>Growth</strong>: These ratios include year over year, 3-year average, 5-year average, and 10-year average growth rates for revenue, operating income, net income, and EPS.</li>
<li><strong>Cash Flow</strong>: These ratios include operating cash flow growth % YOY, free cash flow growth % YOY, capital expenditure as a % of sales, and more.</li>
<li><strong>Financial Health</strong>: These ratios include balance sheet items as a percentage of total assets and liabilities, and liquidty/financial health metrics such as current ratio, quick ratio, debt/equity, and financial leverage.</li>
<li><strong>Efficiency Ratios</strong>: These ratios include days sales outstanding, days inventory, inventory turnover, asset turnover and more.</li>
<li><strong>Valuation Ratios</strong>: These ratios include price to earnings (P/E), price to sales (P/S), price to book (P/B), and price to operating cash flow.</li>
</ul>
<p>To get the key ratios:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_key_ratios &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;key.ratios&quot;</span>)
aapl_key_ratios</code></pre></div>
<pre><code>## # A tibble: 7 × 2
##             section               data
##               &lt;chr&gt;             &lt;list&gt;
## 1        Financials &lt;tibble [150 × 5]&gt;
## 2     Profitability &lt;tibble [170 × 5]&gt;
## 3            Growth &lt;tibble [160 × 5]&gt;
## 4         Cash Flow  &lt;tibble [50 × 5]&gt;
## 5  Financial Health &lt;tibble [240 × 5]&gt;
## 6 Efficiency Ratios  &lt;tibble [80 × 5]&gt;
## 7  Valuation Ratios  &lt;tibble [40 × 5]&gt;</code></pre>
<p>The ratios can be filtered and unnested to peel away the hierarchical nesting layers and access the underlying data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_key_ratios %&gt;%
<span class="st">    </span><span class="kw">filter</span>(section ==<span class="st"> &quot;Valuation Ratios&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">unnest</span>()</code></pre></div>
<pre><code>## # A tibble: 40 × 6
##             section      sub.section group          category       date
##               &lt;chr&gt;            &lt;chr&gt; &lt;dbl&gt;             &lt;chr&gt;     &lt;date&gt;
## 1  Valuation Ratios Valuation Ratios    86 Price to Earnings 2007-12-31
## 2  Valuation Ratios Valuation Ratios    86 Price to Earnings 2008-12-31
## 3  Valuation Ratios Valuation Ratios    86 Price to Earnings 2009-12-31
## 4  Valuation Ratios Valuation Ratios    86 Price to Earnings 2010-12-31
## 5  Valuation Ratios Valuation Ratios    86 Price to Earnings 2011-12-30
## 6  Valuation Ratios Valuation Ratios    86 Price to Earnings 2012-12-31
## 7  Valuation Ratios Valuation Ratios    86 Price to Earnings 2013-12-31
## 8  Valuation Ratios Valuation Ratios    86 Price to Earnings 2014-12-31
## 9  Valuation Ratios Valuation Ratios    86 Price to Earnings 2015-12-31
## 10 Valuation Ratios Valuation Ratios    86 Price to Earnings 2016-12-30
## # ... with 30 more rows, and 1 more variables: value &lt;dbl&gt;</code></pre>
<p>Once we have a section, we can quickly visualize the ratios:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_key_ratios %&gt;%
<span class="st">    </span><span class="kw">filter</span>(section ==<span class="st"> &quot;Valuation Ratios&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">unnest</span>() %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> value)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">col =</span> forcats::<span class="kw">fct_reorder2</span>(category, date, value))) +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;10-Year Historical Valuation Ratios for AAPL&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;&quot;</span>, 
         <span class="dt">y =</span> <span class="st">&quot;&quot;</span>, <span class="dt">col =</span> <span class="st">&quot;&quot;</span>) </code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p>The data source is <a href="http://www.morningstar.com/">Morningstar</a>.</p>
<p><strong>Key Stats</strong>:</p>
<p>For any given stock, the current key statistics are available in real time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_key_stats &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;key.stats&quot;</span>)
aapl_key_stats</code></pre></div>
<pre><code>## # A tibble: 1 × 55
##      Ask Ask.Size Average.Daily.Volume    Bid Bid.Size Book.Value Change
##    &lt;dbl&gt;    &lt;int&gt;                &lt;int&gt;  &lt;dbl&gt;    &lt;int&gt;      &lt;dbl&gt;  &lt;dbl&gt;
## 1 120.06      200             31411400 120.02      400      24.03   0.22
## # ... with 48 more variables: Change.From.200.day.Moving.Average &lt;dbl&gt;,
## #   Change.From.50.day.Moving.Average &lt;dbl&gt;,
## #   Change.From.52.week.High &lt;dbl&gt;, Change.From.52.week.Low &lt;dbl&gt;,
## #   Change.in.Percent &lt;dbl&gt;, Currency &lt;chr&gt;, Days.High &lt;dbl&gt;,
## #   Days.Low &lt;dbl&gt;, Days.Range &lt;chr&gt;, Dividend.Pay.Date &lt;date&gt;,
## #   Dividend.per.Share &lt;dbl&gt;, Dividend.Yield &lt;dbl&gt;, EBITDA &lt;dbl&gt;,
## #   EPS &lt;dbl&gt;, EPS.Estimate.Current.Year &lt;dbl&gt;,
## #   EPS.Estimate.Next.Quarter &lt;dbl&gt;, EPS.Estimate.Next.Year &lt;dbl&gt;,
## #   Ex.Dividend.Date &lt;date&gt;, Float.Shares &lt;dbl&gt;, High.52.week &lt;dbl&gt;,
## #   Last.Trade.Date &lt;date&gt;, Last.Trade.Price.Only &lt;dbl&gt;,
## #   Last.Trade.Size &lt;int&gt;, Last.Trade.With.Time &lt;chr&gt;, Low.52.week &lt;dbl&gt;,
## #   Market.Capitalization &lt;dbl&gt;, Moving.Average.200.day &lt;dbl&gt;,
## #   Moving.Average.50.day &lt;dbl&gt;, Name &lt;chr&gt;, Open &lt;dbl&gt;, PE.Ratio &lt;dbl&gt;,
## #   PEG.Ratio &lt;dbl&gt;, Percent.Change.From.200.day.Moving.Average &lt;dbl&gt;,
## #   Percent.Change.From.50.day.Moving.Average &lt;dbl&gt;,
## #   Percent.Change.From.52.week.High &lt;chr&gt;,
## #   Percent.Change.From.52.week.Low &lt;dbl&gt;, Previous.Close &lt;dbl&gt;,
## #   Price.to.Book &lt;dbl&gt;, Price.to.EPS.Estimate.Current.Year &lt;dbl&gt;,
## #   Price.to.EPS.Estimate.Next.Year &lt;dbl&gt;, Price.to.Sales &lt;dbl&gt;,
## #   Range.52.week &lt;chr&gt;, Revenue &lt;dbl&gt;, Shares.Outstanding &lt;dbl&gt;,
## #   Short.Ratio &lt;dbl&gt;, Stock.Exchange &lt;chr&gt;, Target.Price.1.yr. &lt;dbl&gt;,
## #   Volume &lt;int&gt;</code></pre>
<p>It’s quite a bit of information, with 55 real-time stats available. We can easily get for mulitple stocks and pare down the list for comparisons:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;FB&quot;</span>, <span class="st">&quot;GOOG&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;key.stats&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(symbol.x, Ask, Ask.Size, Bid, Bid.Size, Days.High, Days.Low)</code></pre></div>
<pre><code>## # A tibble: 3 × 7
##   symbol.x    Ask Ask.Size    Bid Bid.Size Days.High Days.Low
##      &lt;chr&gt;  &lt;dbl&gt;    &lt;int&gt;  &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1     AAPL 120.06      200 120.02      400    120.45   119.73
## 2       FB 127.07      100 127.00      300    128.48   126.78
## 3     GOOG 814.00      100 800.00      100    806.91   801.69</code></pre>
<p>Finally, because the statistics are real-time, we can setup real-time monitoring by calling <code>tq_get</code> at periodic intervals. The function below is not evaluated for time considerations, but if called during active trading sessions will collect five samples at three second intervals.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">collect_real_time_data &lt;-<span class="st"> </span>function(x, interval_sec, n) {
    data &lt;-<span class="st"> </span><span class="kw">tibble</span>()
    while (n &gt;<span class="st"> </span><span class="dv">0</span>) {
        data &lt;-<span class="st"> </span><span class="kw">bind_rows</span>(data, <span class="kw">tq_get</span>(x, <span class="dt">get =</span> <span class="st">&quot;key.stats&quot;</span>))
        <span class="kw">Sys.sleep</span>(interval_sec)
        n &lt;-<span class="st"> </span>n -<span class="st"> </span><span class="dv">1</span>
    }
    <span class="kw">return</span>(data)
}
<span class="kw">collect_real_time_data</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="dt">interval_sec =</span> <span class="dv">3</span>, <span class="dt">n =</span> <span class="dv">5</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(Ask, Ask.Size, Bid, Bid.Size, Open, Change)</code></pre></div>
<p>The data source is <a href="https://finance.yahoo.com/">Yahoo Finance</a>.</p>
<p><a class="anchor" id="economic-data"></a></p>
<p><strong>Economic Data</strong>:</p>
<p>A wealth of economic data can be extracted from the Federal Reserve Economic Data (FRED) database. The <a href="https://fred.stlouisfed.org/series/DCOILWTICO">WTI Crude Oil Prices</a> are shown below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wti_price_usd &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;DCOILWTICO&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;economic.data&quot;</span>)
wti_price_usd </code></pre></div>
<pre><code>## # A tibble: 2,622 × 2
##          date price
##        &lt;date&gt; &lt;dbl&gt;
## 1  2007-01-01    NA
## 2  2007-01-02 60.77
## 3  2007-01-03 58.31
## 4  2007-01-04 55.65
## 5  2007-01-05 56.29
## 6  2007-01-08 56.08
## 7  2007-01-09 55.65
## 8  2007-01-10 53.95
## 9  2007-01-11 51.91
## 10 2007-01-12 52.96
## # ... with 2,612 more rows</code></pre>
<p>The FRED contains literally over 10K data sets that are free to use. See the <a href="https://fred.stlouisfed.org/categories">FRED categories</a> to narrow down the data base and to get data codes.</p>
<p><strong>Exchange Rates</strong>:</p>
<p>Exchange rates are entered as currency pairs using “/” notation (e.g <code>&quot;EUR/USD&quot;</code>), and by setting <code>get = &quot;exchange.rates&quot;</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">eur_usd &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;EUR/USD&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;exchange.rates&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2000-01-01&quot;</span>)
eur_usd </code></pre></div>
<pre><code>## # A tibble: 1,827 × 2
##          date exchange.rate
##        &lt;date&gt;         &lt;dbl&gt;
## 1  2012-01-21       1.29329
## 2  2012-01-22       1.29261
## 3  2012-01-23       1.29488
## 4  2012-01-24       1.30089
## 5  2012-01-25       1.30154
## 6  2012-01-26       1.31254
## 7  2012-01-27       1.31292
## 8  2012-01-28       1.32201
## 9  2012-01-29       1.32191
## 10 2012-01-30       1.31522
## # ... with 1,817 more rows</code></pre>
<p>The data source is <a href="https://www.oanda.com/">Oanda</a>, and list of currencies to compare can be found on <a href="https://www.oanda.com/currency/converter/">Oanda’s currency converter</a>. It may make more sense to get this data from the FRED (See <a href="#economic-data">Economic Data</a>) since the max period for Oanda is 5-years.</p>
<p><strong>Metal Prices</strong>:</p>
<p>Metal prices are very similar to stock prices. Set <code>get = &quot;metal.prices&quot;</code> along with the appropriate commodity symbol (e.g. XAU (gold) , XAG (silver), XPD (palladium), or XPT (platinum)).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">plat_price_eur &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;plat&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;metal.prices&quot;</span>, 
                         <span class="dt">from =</span> <span class="st">&quot;2000-01-01&quot;</span>, <span class="dt">base.currency =</span> <span class="st">&quot;EUR&quot;</span>)
plat_price_eur </code></pre></div>
<pre><code>## # A tibble: 1,827 × 2
##          date   price
##        &lt;date&gt;   &lt;dbl&gt;
## 1  2012-01-21 1148.62
## 2  2012-01-22 1182.50
## 3  2012-01-23 1180.42
## 4  2012-01-24 1191.11
## 5  2012-01-25 1190.51
## 6  2012-01-26 1180.53
## 7  2012-01-27 1235.41
## 8  2012-01-28 1226.93
## 9  2012-01-29 1227.39
## 10 2012-01-30 1223.37
## # ... with 1,817 more rows</code></pre>
<p>The data source is <a href="https://www.oanda.com/">Oanda</a>. It may make more sense to get this data from the FRED (See <a href="#economic-data">Economic Data</a>) since the max period for Oanda is 5-years.</p>
<p><a class="anchor" id="tq-transform"></a></p>
</div>
<div id="transform-and-mutate-quantitative-data" class="section level3">
<h3>Transform and Mutate Quantitative Data</h3>
<p>Transform and mutate functions enable the <code>xts</code>, <code>quantmod</code> and <code>TTR</code> functions to shine (see <a href="#quant-power">Leverage the Quantitative Power of <code>xts</code>, <code>quantmod</code> and <code>TTR</code></a>):</p>
<p><strong>Transform Quantitative Data, <code>tq_transform()</code></strong>:</p>
<p>Transforms the results of <code>tq_get()</code>. The result is typically a different shape than the input (hence “transformed”), although this is not a requirement. An example is periodicity aggregation from daily to monthly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fb_prices &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;FB&quot;</span>) 
fb_prices %&gt;%
<span class="st">    </span><span class="kw">tq_transform</span>(<span class="dt">ohlc_fun =</span> OHLCV, <span class="dt">transform_fun =</span> to.monthly)</code></pre></div>
<pre><code>## # A tibble: 57 × 6
##        date  open  high   low close    volume
##       &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
## 1  May 2012 28.55 29.67 26.83 29.60 111639200
## 2  Jun 2012 31.92 31.99 30.76 31.10  19526900
## 3  Jul 2012 23.37 23.37 21.61 21.71  56179400
## 4  Aug 2012 18.68 18.70 18.03 18.06  58764200
## 5  Sep 2012 20.57 21.95 20.50 21.66  65486000
## 6  Oct 2012 20.82 21.50 20.73 21.11  99378200
## 7  Nov 2012 27.26 28.00 26.76 28.00 127049600
## 8  Dec 2012 26.20 26.99 26.11 26.62  60374500
## 9  Jan 2013 29.15 31.47 28.74 30.98 190744900
## 10 Feb 2013 26.84 27.30 26.34 27.25  83027800
## # ... with 47 more rows</code></pre>
<p>Let’s go through what happened. <code>ohlc_fun</code> is one of the various quantmod Open, High, Low, Close (OHLC) functions (see <code>?quantmod::OHLC</code>). The function returns a column or set of columns from data that are passed to the <code>transform_fun</code>. In example above, <code>OHLCV</code> selects the full list of prices and volumes from <code>data</code>, and sends this to the transform function, <code>to.monthly</code>, which transforms the periodicity from daily to monthly. Additional arguments can be passed to the <code>transform_fun</code> by way of <code>...</code>.</p>
<p><strong>Mutate Quantitative Data, <code>tq_mutate()</code></strong>:</p>
<p>Adds a column or set of columns to the tibble with the calculated attributes (hence the original tibble is returned, mutated with the additional columns). An example is getting the <code>MACD</code> from <code>Cl</code> (close price), which mutates the original input by adding MACD and Signal columns. Note that we can quickly rename the columns using the <code>col_rename</code> argument.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fb_prices %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(<span class="dt">ohlc_fun =</span> Cl, <span class="dt">mutate_fun =</span> MACD, <span class="dt">col_rename =</span> <span class="kw">c</span>(<span class="st">&quot;MACD&quot;</span>, <span class="st">&quot;Signal&quot;</span>))</code></pre></div>
<pre><code>## # A tibble: 1,176 × 9
##          date  open  high   low close    volume adjusted  MACD Signal
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1  2012-05-18 42.05 45.00 38.00 38.23 573576400    38.23    NA     NA
## 2  2012-05-21 36.53 36.66 33.00 34.03 168192700    34.03    NA     NA
## 3  2012-05-22 32.61 33.59 30.94 31.00 101786600    31.00    NA     NA
## 4  2012-05-23 31.37 32.50 31.36 32.00  73600000    32.00    NA     NA
## 5  2012-05-24 32.95 33.21 31.77 33.03  50237200    33.03    NA     NA
## 6  2012-05-25 32.90 32.95 31.11 31.91  37149800    31.91    NA     NA
## 7  2012-05-29 31.48 31.69 28.65 28.84  78063400    28.84    NA     NA
## 8  2012-05-30 28.70 29.55 27.86 28.19  57267900    28.19    NA     NA
## 9  2012-05-31 28.55 29.67 26.83 29.60 111639200    29.60    NA     NA
## 10 2012-06-01 28.89 29.15 27.39 27.72  41855500    27.72    NA     NA
## # ... with 1,166 more rows</code></pre>
<p>Note that a mutation can occur if, and only if, the mutation has the same structure of the original tibble. In other words, the calculation must have the same number of rows and row.names (or date fields), otherwise the mutation cannot be performed.</p>
<p><strong>xy Variants, <code>tq_transform_xy</code> and <code>tq_mutate_xy</code></strong>:</p>
<p>Enables working with:</p>
<ol style="list-style-type: decimal">
<li>Transformation functions that require two primary inputs (e.g. EVWMA, VWAP, etc)</li>
<li>Data that is not in OHLC format.</li>
</ol>
<p><em>Transformation with two primary inputs</em>:</p>
<p>EVWMA (exponential volume-weighted moving average) requires two inputs, price and volume, that are not in OHLC code format. To work with these columns, we can switch to the xy variants, <code>tq_transform_xy()</code> and <code>tq_mutate_xy()</code>. The only difference is instead of an <code>ohlc_fun</code> argument, you use <code>x</code> and <code>y</code> arguments to pass the columns needed based on the <code>transform_fun</code> or <code>mutate_fun</code> documentation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fb_prices %&gt;%
<span class="st">    </span><span class="kw">tq_mutate_xy</span>(<span class="dt">x =</span> close, <span class="dt">y =</span> volume, <span class="dt">mutate_fun =</span> EVWMA, <span class="dt">col_rename =</span> <span class="st">&quot;EVWMA&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 1,176 × 8
##          date  open  high   low close    volume adjusted EVWMA
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1  2012-05-18 42.05 45.00 38.00 38.23 573576400    38.23    NA
## 2  2012-05-21 36.53 36.66 33.00 34.03 168192700    34.03    NA
## 3  2012-05-22 32.61 33.59 30.94 31.00 101786600    31.00    NA
## 4  2012-05-23 31.37 32.50 31.36 32.00  73600000    32.00    NA
## 5  2012-05-24 32.95 33.21 31.77 33.03  50237200    33.03    NA
## 6  2012-05-25 32.90 32.95 31.11 31.91  37149800    31.91    NA
## 7  2012-05-29 31.48 31.69 28.65 28.84  78063400    28.84    NA
## 8  2012-05-30 28.70 29.55 27.86 28.19  57267900    28.19    NA
## 9  2012-05-31 28.55 29.67 26.83 29.60 111639200    29.60    NA
## 10 2012-06-01 28.89 29.15 27.39 27.72  41855500    27.72 27.72
## # ... with 1,166 more rows</code></pre>
<p><em>Working with non-OHLC data</em>:</p>
<p>Returns from FRED, Oanda, and other sources do not have open, high, low, close, and volume (OHLCV) format. The following example shows how to transform WTI Crude daily prices to monthly prices. Since we only have a single column to pass, set the <code>x = price</code> and leave the <code>y = NULL</code>. This sends the price column to the <code>to.period</code> transformation fuction.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">wti_prices &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;DCOILWTICO&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;economic.data&quot;</span>) 
wti_prices %&gt;%<span class="st">    </span>
<span class="st">    </span><span class="kw">tq_transform_xy</span>(<span class="dt">x =</span> price, <span class="dt">transform_fun =</span> to.period,
                    <span class="dt">period =</span> <span class="st">&quot;months&quot;</span>, <span class="dt">col_rename =</span> <span class="st">&quot;WTI Price&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 121 × 2
##          date `WTI Price`
##        &lt;dttm&gt;       &lt;dbl&gt;
## 1  2007-01-31       58.17
## 2  2007-02-28       61.78
## 3  2007-03-30       65.94
## 4  2007-04-30       65.78
## 5  2007-05-31       64.02
## 6  2007-06-29       70.47
## 7  2007-07-31       78.20
## 8  2007-08-31       73.98
## 9  2007-09-28       81.64
## 10 2007-10-31       94.16
## # ... with 111 more rows</code></pre>
<p><a class="anchor" id="tq-coerce"></a></p>
</div>
<div id="coercing-time-series-objects-to-and-from-tibble" class="section level3">
<h3>Coercing Time Series Objects To and From Tibble</h3>
<p>Sometimes you want to work using a <code>tibble</code> and other times you want to work using a <code>xts</code> object. The <code>as_tibble()</code> and <code>as_xts()</code> functions are the key.</p>
<p><strong>Coerce from time-series to tibble, <code>as_tibble()</code></strong>:</p>
<p>The <code>tidyquant::as_tibble()</code> function includes a <code>preserve_row_names</code> argument, which is useful when coercing one of the many time formats (e.g. <code>xts</code>, <code>zoo</code>, <code>timeSeries</code>, <code>ts</code>) or <code>matrix</code> objects that contain valuable information in the row names. This makes bridging the gap between the various quantitative analysis packages and the <code>tidyverse</code> much easier.</p>
<p>Let’s start with an <code>xts</code> object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create xts object from a matrix</span>
vals =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">c</span>(<span class="dv">500</span>, <span class="dv">504</span>, <span class="dv">503</span>))
date =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;2016-01-01&quot;</span>, <span class="st">&quot;2016-01-02&quot;</span>, <span class="st">&quot;2016-01-03&quot;</span>) 
<span class="kw">rownames</span>(vals) &lt;-<span class="st"> </span>date
time_series_xts &lt;-<span class="st"> </span><span class="kw">as_xts</span>(vals)
time_series_xts</code></pre></div>
<pre><code>##            [,1]
## 2016-01-01  500
## 2016-01-02  504
## 2016-01-03  503</code></pre>
<p>We can easily coerce to <code>tibble</code> by setting <code>preserve_row_names = TRUE</code>. Note the return column is <code>row.names</code> with class of <code>character</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time_series_tbl &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(time_series_xts, <span class="dt">preserve_row_names =</span> <span class="ot">TRUE</span>)
time_series_tbl</code></pre></div>
<pre><code>## # A tibble: 3 × 2
##    row.names    V1
##        &lt;chr&gt; &lt;dbl&gt;
## 1 2016-01-01   500
## 2 2016-01-02   504
## 3 2016-01-03   503</code></pre>
<p>Converting to date is one extra step with <code>lubridate</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time_series_tbl &lt;-<span class="st"> </span>time_series_tbl %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">row.names =</span> lubridate::<span class="kw">ymd</span>(row.names))
time_series_tbl</code></pre></div>
<pre><code>## # A tibble: 3 × 2
##    row.names    V1
##       &lt;date&gt; &lt;dbl&gt;
## 1 2016-01-01   500
## 2 2016-01-02   504
## 3 2016-01-03   503</code></pre>
<p><strong>Coerce from tibble to xts, <code>as_xts()</code></strong>:</p>
<p>We can convert back to <code>xts</code> with the tidyquant <code>as_xts()</code> function. Make sure to set the date column (<code>date_col</code>) argument to the column name containing the date (<code>date_col = row.names</code>). The date column must be in a date format (inherits either <code>Date</code> or <code>POSIXct</code> classes).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">time_series_xts &lt;-<span class="st"> </span>time_series_tbl %&gt;%
<span class="st">    </span><span class="kw">as_xts</span>(<span class="dt">date_col =</span> row.names)
time_series_xts</code></pre></div>
<pre><code>##             V1
## 2016-01-01 500
## 2016-01-02 504
## 2016-01-03 503</code></pre>
<p><a class="anchor" id="tidyverse"></a></p>
</div>
</div>
<div id="work-in-the-tidyverse" class="section level2">
<h2>Work in the tidyverse</h2>
<p>You probably already know and love <code>tidyverse</code> packages like <code>ggplot2</code>, <code>dplyr</code>, <code>tidyr</code>, <code>purrr</code>, <code>readr</code>, and <code>tibble</code> along with <code>lubridate</code> for working with date and datetime. <code>tidyquant</code> works solely in tibbles, so all of the <code>tidyverse</code> functionality is intact.</p>
<p>A simple example inspired by <a href="https://blog.exploratory.io/introducing-time-series-analysis-with-dplyr-60683587cf8a#.w6pvyi3d2">Kan Nishida’s blog</a> shows the <code>dplyr</code> and <code>lubridate</code> capability: Say we want the growth in the stock over the past year. We can do this with <code>dplyr</code> operations.</p>
<p>Getting the last year is simple with <code>dplyr</code> and <code>lubridate</code>. We first <code>select</code> the date and adjusted price (adjusted for stock splits). We then <code>filter</code> using <code>lubridate</code> date functions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_prices %&gt;%
<span class="st">    </span><span class="kw">select</span>(date, adjusted) %&gt;%
<span class="st">    </span><span class="kw">filter</span>(date &gt;=<span class="st"> </span><span class="kw">today</span>() -<span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>))</code></pre></div>
<pre><code>## # A tibble: 253 × 2
##          date adjusted
##        &lt;date&gt;    &lt;dbl&gt;
## 1  2016-01-21 94.20404
## 2  2016-01-22 99.21260
## 3  2016-01-25 97.27570
## 4  2016-01-26 97.81372
## 5  2016-01-27 91.38672
## 6  2016-01-28 92.04213
## 7  2016-01-29 95.22140
## 8  2016-02-01 94.33121
## 9  2016-02-02 92.42365
## 10 2016-02-03 94.25295
## # ... with 243 more rows</code></pre>
<p>We can also get a baseline price using the <code>first</code> function. Adding to our workflow, this looks like:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_prices %&gt;%
<span class="st">    </span><span class="kw">select</span>(date, adjusted) %&gt;%
<span class="st">    </span><span class="kw">filter</span>(date &gt;=<span class="st"> </span><span class="kw">today</span>() -<span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">baseline =</span> <span class="kw">first</span>(adjusted))</code></pre></div>
<pre><code>## # A tibble: 253 × 3
##          date adjusted baseline
##        &lt;date&gt;    &lt;dbl&gt;    &lt;dbl&gt;
## 1  2016-01-21 94.20404 94.20404
## 2  2016-01-22 99.21260 94.20404
## 3  2016-01-25 97.27570 94.20404
## 4  2016-01-26 97.81372 94.20404
## 5  2016-01-27 91.38672 94.20404
## 6  2016-01-28 92.04213 94.20404
## 7  2016-01-29 95.22140 94.20404
## 8  2016-02-01 94.33121 94.20404
## 9  2016-02-02 92.42365 94.20404
## 10 2016-02-03 94.25295 94.20404
## # ... with 243 more rows</code></pre>
<p>Growth and growth percent versus baseline columns can be added now. We tack on a final <code>select</code> statement to remove unnecessary columns. The final workflow looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_growth &lt;-<span class="st"> </span>aapl_prices %&gt;%
<span class="st">    </span><span class="kw">select</span>(date, adjusted) %&gt;%
<span class="st">    </span><span class="kw">filter</span>(date &gt;=<span class="st"> </span><span class="kw">today</span>() -<span class="st"> </span><span class="kw">years</span>(<span class="dv">1</span>)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">baseline =</span> <span class="kw">first</span>(adjusted),
           <span class="dt">growth =</span> adjusted -<span class="st"> </span>baseline,
           <span class="dt">growth.pct =</span> growth /<span class="st"> </span>baseline) %&gt;%
<span class="st">    </span><span class="kw">select</span>(-(baseline:growth))
aapl_growth</code></pre></div>
<pre><code>## # A tibble: 253 × 3
##          date adjusted    growth.pct
##        &lt;date&gt;    &lt;dbl&gt;         &lt;dbl&gt;
## 1  2016-01-21 94.20404  0.0000000000
## 2  2016-01-22 99.21260  0.0531671359
## 3  2016-01-25 97.27570  0.0326064254
## 4  2016-01-26 97.81372  0.0383176985
## 5  2016-01-27 91.38672 -0.0299065942
## 6  2016-01-28 92.04213 -0.0229491856
## 7  2016-01-29 95.22140  0.0107995156
## 8  2016-02-01 94.33121  0.0013499209
## 9  2016-02-02 92.42365 -0.0188992744
## 10 2016-02-03 94.25295  0.0005191603
## # ... with 243 more rows</code></pre>
<p>And, we can quickly plot using <code>ggplot2</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">aapl_growth %&gt;%
<span class="st">    </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> growth.pct)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>() +
<span class="st">    </span><span class="kw">labs</span>(<span class="dt">title =</span> <span class="st">&quot;AAPL: Growth Over One Year&quot;</span>, <span class="dt">x =</span> <span class="st">&quot;&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;Growth&quot;</span>) +
<span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales::percent)</code></pre></div>
<p><img src="data:image/png;base64,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" /><!-- --></p>
<p><a class="anchor" id="quant-power"></a></p>
</div>
<div id="leverage-the-quantitative-power-of-xts-quantmod-and-ttr" class="section level2">
<h2>Leverage the Quantitative Power of xts, quantmod and TTR</h2>
<p>You may already know and love <code>xts</code> / <code>zoo</code>, <code>quantmod</code> and <code>TTR</code>, which is why the core functionality is fully intact. Using <code>tq_transform()</code> and <code>tq_mutate()</code>, we can apply the <code>zoo</code>, <code>xts</code>, <code>quantmod</code> and <code>TTR</code> functions. Entering <code>tq_transform_fun_options()</code> returns a list the transform functions by each package. We’ll discuss these options by package briefly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_transform_fun_options</span>() %&gt;%<span class="st"> </span><span class="kw">str</span>()</code></pre></div>
<pre><code>## List of 4
##  $ zoo     : chr [1:14] &quot;rollapply&quot; &quot;rollapplyr&quot; &quot;rollmax&quot; &quot;rollmax.default&quot; ...
##  $ xts     : chr [1:27] &quot;apply.daily&quot; &quot;apply.monthly&quot; &quot;apply.quarterly&quot; &quot;apply.weekly&quot; ...
##  $ quantmod: chr [1:25] &quot;allReturns&quot; &quot;annualReturn&quot; &quot;ClCl&quot; &quot;dailyReturn&quot; ...
##  $ TTR     : chr [1:61] &quot;adjRatios&quot; &quot;ADX&quot; &quot;ALMA&quot; &quot;aroon&quot; ...</code></pre>
<div id="zoo-functionality" class="section level3">
<h3>zoo Functionality</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get zoo functions that work with tq_transform and tq_mutate</span>
<span class="kw">tq_transform_fun_options</span>()$zoo</code></pre></div>
<pre><code>##  [1] &quot;rollapply&quot;          &quot;rollapplyr&quot;         &quot;rollmax&quot;           
##  [4] &quot;rollmax.default&quot;    &quot;rollmaxr&quot;           &quot;rollmean&quot;          
##  [7] &quot;rollmean.default&quot;   &quot;rollmeanr&quot;          &quot;rollmedian&quot;        
## [10] &quot;rollmedian.default&quot; &quot;rollmedianr&quot;        &quot;rollsum&quot;           
## [13] &quot;rollsum.default&quot;    &quot;rollsumr&quot;</code></pre>
<p>The <code>zoo</code> functions that are compatible are listed above. Generally speaking, these are the:</p>
<ul>
<li>Roll Apply Functions:
<ul>
<li>A generic function for applying a function to rolling margins.</li>
<li>Form: <code>rollapply(data, width, FUN, ..., by = 1, by.column = TRUE, fill = if (na.pad) NA, na.pad = FALSE, partial = FALSE, align = c(&quot;center&quot;, &quot;left&quot;, &quot;right&quot;), coredata = TRUE)</code>.</li>
<li>Options include <code>rollmax</code>, <code>rollmean</code>, <code>rollmedian</code>, <code>rollsum</code>, etc.</li>
</ul></li>
</ul>
</div>
<div id="xts-functionality" class="section level3">
<h3>xts Functionality</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get xts functions that work with tq_transform and tq_mutate</span>
<span class="kw">tq_transform_fun_options</span>()$xts</code></pre></div>
<pre><code>##  [1] &quot;apply.daily&quot;     &quot;apply.monthly&quot;   &quot;apply.quarterly&quot;
##  [4] &quot;apply.weekly&quot;    &quot;apply.yearly&quot;    &quot;diff.xts&quot;       
##  [7] &quot;lag.xts&quot;         &quot;period.apply&quot;    &quot;period.max&quot;     
## [10] &quot;period.min&quot;      &quot;period.prod&quot;     &quot;period.sum&quot;     
## [13] &quot;periodicity&quot;     &quot;to.daily&quot;        &quot;to.hourly&quot;      
## [16] &quot;to.minutes&quot;      &quot;to.minutes10&quot;    &quot;to.minutes15&quot;   
## [19] &quot;to.minutes3&quot;     &quot;to.minutes30&quot;    &quot;to.minutes5&quot;    
## [22] &quot;to.monthly&quot;      &quot;to.period&quot;       &quot;to.quarterly&quot;   
## [25] &quot;to.weekly&quot;       &quot;to.yearly&quot;       &quot;to_period&quot;</code></pre>
<p>The <code>xts</code> functions that are compatible are listed above. Generally speaking, these are the:</p>
<ul>
<li>Period Apply Functions:
<ul>
<li>Apply a function to a time segment (e.g. <code>max</code>, <code>min</code>, <code>mean</code>, etc).</li>
<li>Form: <code>apply.daily(x, FUN, ...)</code>.</li>
<li>Options include apply.daily, weekly, monthly, quarterly, yearly.</li>
</ul></li>
<li>To-Period Functions:
<ul>
<li>Convert a time series to time series of lower periodicity (e.g. convert daily to monthly periodicity).</li>
<li>Form: <code>to.period(x, period = 'months', k = 1, indexAt, name = NULL, OHLC = TRUE, ...)</code>.</li>
<li>Options include to.minutes, hourly, daily, weekly, monthly, quarterly, yearly.</li>
<li><strong>Note 1 (Important)</strong>: The return structure is different for <code>to.period</code> and the <code>to.monthly</code> (<code>to.weekly</code>, <code>to.quarterly</code>, etc) forms. <code>to.period</code> returns a date, while <code>to.months</code> returns a character MON YYYY. Best to use <code>to.period</code> if you want to work with time-series via <code>lubridate</code>.</li>
</ul></li>
</ul>
</div>
<div id="quantmod-functionality" class="section level3">
<h3>quantmod Functionality</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get quantmod functions that work with tq_transform and tq_mutate</span>
<span class="kw">tq_transform_fun_options</span>()$quantmod</code></pre></div>
<pre><code>##  [1] &quot;allReturns&quot;      &quot;annualReturn&quot;    &quot;ClCl&quot;           
##  [4] &quot;dailyReturn&quot;     &quot;Delt&quot;            &quot;HiCl&quot;           
##  [7] &quot;Lag&quot;             &quot;LoCl&quot;            &quot;LoHi&quot;           
## [10] &quot;monthlyReturn&quot;   &quot;Next&quot;            &quot;OpCl&quot;           
## [13] &quot;OpHi&quot;            &quot;OpLo&quot;            &quot;OpOp&quot;           
## [16] &quot;periodReturn&quot;    &quot;quarterlyReturn&quot; &quot;seriesAccel&quot;    
## [19] &quot;seriesDecel&quot;     &quot;seriesDecr&quot;      &quot;seriesHi&quot;       
## [22] &quot;seriesIncr&quot;      &quot;seriesLo&quot;        &quot;weeklyReturn&quot;   
## [25] &quot;yearlyReturn&quot;</code></pre>
<p>The <code>quantmod</code> functions that are compatible are listed above. Generally speaking, these are the:</p>
<ul>
<li>Percentage Change (Delt) and Lag Functions
<ul>
<li>Delt: <code>Delt(x1, x2 = NULL, k = 0, type = c(&quot;arithmetic&quot;, &quot;log&quot;))</code>
<ul>
<li>Variations of Delt: ClCl, HiCl, LoCl, LoHi, OpCl, OpHi, OpLo, OpOp</li>
<li>Form: <code>OpCl(OHLC)</code></li>
</ul></li>
<li>Lag: <code>Lag(x, k = 1)</code> / Next: <code>Next(x, k = 1)</code> (Can also use <code>dplyr::lag</code> and <code>dplyr::lead</code>)</li>
</ul></li>
<li>Period Return Functions:
<ul>
<li>Get the arithmetic or logarithmic returns for various periodicities, which include daily, weekly, monthly, quarterly, and yearly.</li>
<li>Form: <code>periodReturn(x, period = 'monthly', subset = NULL, type = 'arithmetic', leading = TRUE, ...)</code></li>
</ul></li>
<li>Series Functions:
<ul>
<li>Return values that describe the series. Options include describing the increases/decreases, accelerations/decelerations, and hi/low.</li>
<li>Forms: <code>seriesHi(x)</code>, <code>seriesIncr(x, thresh = 0, diff. = 1L)</code>, <code>seriesAccel(x)</code></li>
</ul></li>
</ul>
</div>
<div id="ttr-functionality" class="section level3">
<h3>TTR Functionality</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Get TTR functions that work with tq_transform and tq_mutate</span>
<span class="kw">tq_transform_fun_options</span>()$TTR</code></pre></div>
<pre><code>##  [1] &quot;adjRatios&quot;          &quot;ADX&quot;                &quot;ALMA&quot;              
##  [4] &quot;aroon&quot;              &quot;ATR&quot;                &quot;BBands&quot;            
##  [7] &quot;CCI&quot;                &quot;chaikinAD&quot;          &quot;chaikinVolatility&quot; 
## [10] &quot;CLV&quot;                &quot;CMF&quot;                &quot;CMO&quot;               
## [13] &quot;DEMA&quot;               &quot;DonchianChannel&quot;    &quot;DPO&quot;               
## [16] &quot;DVI&quot;                &quot;EMA&quot;                &quot;EMV&quot;               
## [19] &quot;EVWMA&quot;              &quot;GMMA&quot;               &quot;growth&quot;            
## [22] &quot;HMA&quot;                &quot;KST&quot;                &quot;lags&quot;              
## [25] &quot;MACD&quot;               &quot;MFI&quot;                &quot;momentum&quot;          
## [28] &quot;OBV&quot;                &quot;PBands&quot;             &quot;ROC&quot;               
## [31] &quot;rollSFM&quot;            &quot;RSI&quot;                &quot;runCor&quot;            
## [34] &quot;runCov&quot;             &quot;runMAD&quot;             &quot;runMax&quot;            
## [37] &quot;runMean&quot;            &quot;runMedian&quot;          &quot;runMin&quot;            
## [40] &quot;runPercentRank&quot;     &quot;runSD&quot;              &quot;runSum&quot;            
## [43] &quot;runVar&quot;             &quot;SAR&quot;                &quot;SMA&quot;               
## [46] &quot;SMI&quot;                &quot;stoch&quot;              &quot;TDI&quot;               
## [49] &quot;TRIX&quot;               &quot;ultimateOscillator&quot; &quot;VHF&quot;               
## [52] &quot;VMA&quot;                &quot;volatility&quot;         &quot;VWAP&quot;              
## [55] &quot;VWMA&quot;               &quot;wilderSum&quot;          &quot;williamsAD&quot;        
## [58] &quot;WMA&quot;                &quot;WPR&quot;                &quot;ZigZag&quot;            
## [61] &quot;ZLEMA&quot;</code></pre>
<p>Here’ a brief description of the most popular functions from <code>TTR</code>:</p>
<ul>
<li>Welles Wilder’s Directional Movement Index:
<ul>
<li><code>ADX(HLC, n = 14, maType, ...)</code></li>
</ul></li>
<li>Bollinger Bands:
<ul>
<li><code>BBands(HLC, n = 20, maType, sd = 2, ...)</code>: Bollinger Bands</li>
</ul></li>
<li>Rate of Change / Momentum:
<ul>
<li><code>ROC(x, n = 1, type = c(&quot;continuous&quot;, &quot;discrete&quot;), na.pad = TRUE)</code>: Rate of Change</li>
<li><code>momentum(x, n = 1, na.pad = TRUE)</code>: Momentum</li>
</ul></li>
<li>Moving Averages (maType):
<ul>
<li><code>SMA(x, n = 10, ...)</code>: Simple Moving Average</li>
<li><code>EMA(x, n = 10, wilder = FALSE, ratio = NULL, ...)</code>: Exponential Moving Average</li>
<li><code>DEMA(x, n = 10, v = 1, wilder = FALSE, ratio = NULL)</code>: Double Exponential Moving Average</li>
<li><code>WMA(x, n = 10, wts = 1:n, ...)</code>: Weighted Moving Average</li>
<li><code>EVWMA(price, volume, n = 10, ...)</code>: Elastic, Volume-Weighted Moving Average</li>
<li><code>ZLEMA(x, n = 10, ratio = NULL, ...)</code>: Zero Lag Exponential Moving Average</li>
<li><code>VWAP(price, volume, n = 10, ...)</code>: Volume-Weighted Moving Average Price</li>
<li><code>VMA(x, w, ratio = 1, ...)</code>: Variable-Length Moving Average</li>
<li><code>HMA(x, n = 20, ...)</code>: Hull Moving Average</li>
<li><code>ALMA(x, n = 9, offset = 0.85, sigma = 6, ...)</code>: Arnaud Legoux Moving Average</li>
</ul></li>
<li>MACD Oscillator:
<ul>
<li><code>MACD(x, nFast = 12, nSlow = 26, nSig = 9, maType, percent = TRUE, ...)</code></li>
</ul></li>
<li>Relative Strength Index:
<ul>
<li><code>RSI(price, n = 14, maType, ...)</code></li>
</ul></li>
<li>runFun:
<ul>
<li><code>runSum(x, n = 10, cumulative = FALSE)</code>: returns sums over a n-period moving window.</li>
<li><code>runMin(x, n = 10, cumulative = FALSE)</code>: returns minimums over a n-period moving window.</li>
<li><code>runMax(x, n = 10, cumulative = FALSE)</code>: returns maximums over a n-period moving window.</li>
<li><code>runMean(x, n = 10, cumulative = FALSE)</code>: returns means over a n-period moving window.</li>
<li><code>runMedian(x, n = 10, non.unique = &quot;mean&quot;, cumulative = FALSE)</code>: returns medians over a n-period moving window.</li>
<li><code>runCov(x, y, n = 10, use = &quot;all.obs&quot;, sample = TRUE, cumulative = FALSE)</code>: returns covariances over a n-period moving window.</li>
<li><code>runCor(x, y, n = 10, use = &quot;all.obs&quot;, sample = TRUE, cumulative = FALSE)</code>: returns correlations over a n-period moving window.</li>
<li><code>runVar(x, y = NULL, n = 10, sample = TRUE, cumulative = FALSE)</code>: returns variances over a n-period moving window.</li>
<li><code>runSD(x, n = 10, sample = TRUE, cumulative = FALSE)</code>: returns standard deviations over a n-period moving window.</li>
<li><code>runMAD(x, n = 10, center = NULL, stat = &quot;median&quot;, constant = 1.4826, non.unique = &quot;mean&quot;, cumulative = FALSE)</code>: returns median/mean absolute deviations over a n-period moving window.</li>
<li><code>wilderSum(x, n = 10)</code>: retuns a Welles Wilder style weighted sum over a n-period moving window.</li>
</ul></li>
<li>Stochastic Oscillator / Stochastic Momentum Index:
<ul>
<li><code>stoch(HLC, nFastK = 14, nFastD = 3, nSlowD = 3, maType, bounded = TRUE, smooth = 1, ...)</code>: Stochastic Oscillator</li>
<li><code>SMI(HLC, n = 13, nFast = 2, nSlow = 25, nSig = 9, maType, bounded = TRUE, ...)</code>: Stochastic Momentum Index</li>
</ul></li>
</ul>
</div>
<div id="quantitative-power-in-action" class="section level3">
<h3>Quantitative Power In Action</h3>
<p>We’ll go through some examples, but first let’s get some data. The default for <code>tq_get()</code> is <code>get = &quot;stock.prices&quot;</code>, so all we need is to give <code>x</code> a stock symbol.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;AAPL&quot;</span>)</code></pre></div>
<div id="example-1-getting-the-max-close-price-for-each-quarter." class="section level4">
<h4>Example 1: Getting the Max Close Price for Each Quarter.</h4>
<p>The <code>xts::apply.quarterly()</code> function that is part of the period apply group can be used to apply functions by quarterly time segments. Because we are seeking a return structure that is on a different time scale than the input (quarterly versus daily), we need to use a transform function. We select <code>tq_transform</code> and pass the close price using OHLC format via <code>ohlc_fun = Cl</code>, and we send this subset of the data to the <code>apply.quarterly</code> function via the <code>transform_fun</code> argument. Looking at the documentation for <code>apply.quarterly</code>, we see that we can pass a function to the argument, <code>FUN</code>. We want the maximum values, so we set <code>FUN = max</code>. The result is the quarters returned as a date and the maximum closing price during the quarter returned as a double.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_transform</span>(<span class="dt">ohlc_fun =</span> Cl, <span class="dt">transform_fun =</span> apply.quarterly, <span class="dt">FUN =</span> max)</code></pre></div>
<pre><code>## # A tibble: 41 × 2
##          date  close
##        &lt;dttm&gt;  &lt;dbl&gt;
## 1  2007-03-30  97.10
## 2  2007-06-29 125.09
## 3  2007-09-28 154.50
## 4  2007-12-31 199.83
## 5  2008-03-31 194.93
## 6  2008-06-30 189.96
## 7  2008-09-30 179.55
## 8  2008-12-31 111.04
## 9  2009-03-31 109.87
## 10 2009-06-30 144.67
## # ... with 31 more rows</code></pre>
<p>Note that as an alternative you could use the xy form, replacing <code>ohlc_fun = Cl</code> with <code>x = close</code>.</p>
</div>
<div id="example-2-getting-daily-log-returns" class="section level4">
<h4>Example 2: Getting Daily Log Returns</h4>
<p>The <code>quantmod::periodReturn()</code> function generates returns by periodicity. We have a few options here. Normally I go with a transform function, <code>tq_transform</code>, because the <code>periodReturn</code> function accepts different periodicity options, and anything other than daily will blow up a mutation. But, in our situation the period returns periodicity is the same as the stock prices periodicity (both daily), so we can use either. We want to use the adjusted closing prices column (adjusted for stock splits, which can make it appear that a stock is performing poorly if a split is included), so we set <code>ohlc_fun = Ad</code>. We researched the <code>periodReturn</code> function, and we found that it accepts <code>type = &quot;log&quot;</code> and <code>period = &quot;daily&quot;</code>, which returns the daily log returns.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_transform</span>(<span class="dt">ohlc_fun =</span> Ad, <span class="dt">transform_fun =</span> periodReturn, 
                 <span class="dt">type =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">period =</span> <span class="st">&quot;daily&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 2,531 × 2
##          date daily.returns
##        &lt;dttm&gt;         &lt;dbl&gt;
## 1  2007-01-03   0.000000000
## 2  2007-01-04   0.021952915
## 3  2007-01-05  -0.007146656
## 4  2007-01-08   0.004926215
## 5  2007-01-09   0.079799676
## 6  2007-01-10   0.046745766
## 7  2007-01-11  -0.012448172
## 8  2007-01-12  -0.012393888
## 9  2007-01-16   0.025872526
## 10 2007-01-17  -0.022390960
## # ... with 2,521 more rows</code></pre>
</div>
<div id="example-3-adding-macd-and-bollinger-bands-to-a-ohlc-data-set" class="section level4">
<h4>Example 3: Adding MACD and Bollinger Bands to a OHLC data set</h4>
<p>In reviewing the available options in the <code>TTR</code> package, we see that <code>MACD</code> and <code>BBands</code> functions will get us where we need to be. In researching the documentation, the return is in the same periodicity as the input and the functions work with OHLC functions, so we can use <code>tq_mutate()</code>. MACD requires a price, so we select close using <code>Cl</code>, BBands requires high, low, and close, prices so we use <code>HLC</code>. We can chain the inputs together using the pipe (<code>%&gt;%</code>) since mutate just adds columns. The result is a tibble containing the MACD and Bollinger Band results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Cl, MACD) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(HLC, BBands)</code></pre></div>
<pre><code>## # A tibble: 2,531 × 13
##          date  open  high   low close    volume adjusted  macd signal
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
## 1  2007-01-03 86.29 86.58 81.90 83.80 309579900 10.90416    NA     NA
## 2  2007-01-04 84.05 85.95 83.82 85.66 211815100 11.14619    NA     NA
## 3  2007-01-05 85.77 86.20 84.40 85.05 208685400 11.06681    NA     NA
## 4  2007-01-08 85.96 86.53 85.28 85.47 199276700 11.12147    NA     NA
## 5  2007-01-09 86.45 92.98 85.15 92.57 837324600 12.04533    NA     NA
## 6  2007-01-10 94.75 97.80 93.45 97.00 738220000 12.62176    NA     NA
## 7  2007-01-11 95.94 96.78 95.10 95.80 360063200 12.46562    NA     NA
## 8  2007-01-12 94.59 95.06 93.23 94.62 328172600 12.31207    NA     NA
## 9  2007-01-16 95.68 97.25 95.45 97.10 311019100 12.63477    NA     NA
## 10 2007-01-17 97.56 97.60 94.82 94.95 411565000 12.35501    NA     NA
## # ... with 2,521 more rows, and 4 more variables: dn &lt;dbl&gt;, mavg &lt;dbl&gt;,
## #   up &lt;dbl&gt;, pctB &lt;dbl&gt;</code></pre>
<p>Note that for the MACD, we could have used <code>tq_mutate_xy()</code>, setting <code>x = close</code>. However, for the BBands, we are forced to use <code>tq_mutate()</code> because of the HLC input.</p>
</div>
<div id="example-4-getting-the-percentage-difference-between-open-and-close-from-zero-to-five-periods" class="section level4">
<h4>Example 4: Getting the Percentage Difference Between Open and Close from Zero to Five Periods</h4>
<p>We can’t use the <code>OpCl</code> function for this task since it only returns the percentage difference for a period lag of zero. We keep digging and we find the base <code>Delt</code> function from quantmod. In researching the function, we see that <code>Delt</code> takes one or two inputs, <code>k</code> a series of lags, and the type of difference, either arithmetic or log. We will set <code>x = open</code> and <code>y = close</code> and <code>k = 0:5</code> to get zero through five periods. The default <code>type = &quot;arithmetic&quot;</code> is acceptable, so there is no need to specify. The result is the percentage difference between the open and close prices for periods zero to five.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_mutate_xy</span>(<span class="dt">x =</span> open, <span class="dt">y =</span> close, <span class="dt">mutate_fun =</span> Delt, <span class="dt">k =</span> <span class="dv">0</span>:<span class="dv">5</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(-<span class="kw">c</span>(high, low, volume, adjusted))</code></pre></div>
<pre><code>## # A tibble: 2,531 × 9
##          date  open close Delt.0.arithmetic Delt.1.arithmetic
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt;             &lt;dbl&gt;             &lt;dbl&gt;
## 1  2007-01-03 86.29 83.80     -0.0288561482                NA
## 2  2007-01-04 84.05 85.66      0.0191552288      -0.007300974
## 3  2007-01-05 85.77 85.05     -0.0083945785       0.011897632
## 4  2007-01-08 85.96 85.47     -0.0057003026      -0.003497726
## 5  2007-01-09 86.45 92.57      0.0707923631       0.076896291
## 6  2007-01-10 94.75 97.00      0.0237466810       0.122035785
## 7  2007-01-11 95.94 95.80     -0.0014592141       0.011081837
## 8  2007-01-12 94.59 94.62      0.0003171688      -0.013758568
## 9  2007-01-16 95.68 97.10      0.0148411267       0.026535542
## 10 2007-01-17 97.56 94.95     -0.0267528282      -0.007629630
## # ... with 2,521 more rows, and 4 more variables: Delt.2.arithmetic &lt;dbl&gt;,
## #   Delt.3.arithmetic &lt;dbl&gt;, Delt.4.arithmetic &lt;dbl&gt;,
## #   Delt.5.arithmetic &lt;dbl&gt;</code></pre>
<p>For comparison we’ll inspect the output from the <code>OpCl()</code> function using <code>tq_mutate()</code>. We send OHLC prices to the OpCl function. As expected the <code>OpCl..</code> column returned is the same as <code>Delt.0.arithmetic</code> from above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(OHLC, OpCl) %&gt;%
<span class="st">    </span><span class="kw">select</span>(-<span class="kw">c</span>(high, low, volume, adjusted))</code></pre></div>
<pre><code>## # A tibble: 2,531 × 4
##          date  open close        OpCl..
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;
## 1  2007-01-03 86.29 83.80 -0.0288561482
## 2  2007-01-04 84.05 85.66  0.0191552288
## 3  2007-01-05 85.77 85.05 -0.0083945785
## 4  2007-01-08 85.96 85.47 -0.0057003026
## 5  2007-01-09 86.45 92.57  0.0707923631
## 6  2007-01-10 94.75 97.00  0.0237466810
## 7  2007-01-11 95.94 95.80 -0.0014592141
## 8  2007-01-12 94.59 94.62  0.0003171688
## 9  2007-01-16 95.68 97.10  0.0148411267
## 10 2007-01-17 97.56 94.95 -0.0267528282
## # ... with 2,521 more rows</code></pre>
</div>
<div id="example-5-get-the-5-10-15-day-rolling-minimum-and-maximum-values-of-the-adjusted-prices" class="section level4">
<h4>Example 5: Get the 5, 10, 15-Day Rolling Minimum and Maximum Values of the Adjusted Prices</h4>
<p>Rolling functions come from the <code>zoo</code> package. In reviewing the available options, we see that <code>rollmax</code> is present but no there is no <code>rollmin</code>. However, the generic <code>rollapply</code> function will work with any function, so let’s use that. In reviewing the documentation, the <code>rollapply()</code> function takes three primary arguments: <code>data</code>, <code>width</code> and <code>FUN</code>. The <code>data</code> is passed using the <code>ohlc_fun</code> argument, so we don’t need to worry about this. The <code>width</code> is the number of periods to apply the function, and for our situation this is 5, 10, and 15. The <code>FUN</code> is the function to apply, and for our situation this is <code>min</code> and <code>max</code>. We want the result to add columns to our data set, so we use the <code>tq_mutate()</code> function, which allows us to pipe (<code>%&gt;%</code>) each mutation. Putting it all together:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">AAPL %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">5</span>, <span class="dt">FUN =</span> min, <span class="dt">col_rename =</span> <span class="st">&quot;roll.min.5&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">10</span>, <span class="dt">FUN =</span> min, <span class="dt">col_rename =</span> <span class="st">&quot;roll.min.10&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">15</span>, <span class="dt">FUN =</span> min, <span class="dt">col_rename =</span> <span class="st">&quot;roll.min.15&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">5</span>, <span class="dt">FUN =</span> max, <span class="dt">col_rename =</span> <span class="st">&quot;roll.max.5&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">10</span>, <span class="dt">FUN =</span> max, <span class="dt">col_rename =</span> <span class="st">&quot;roll.max.10&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_mutate</span>(Ad, rollapply, <span class="dt">width =</span> <span class="dv">15</span>, <span class="dt">FUN =</span> max, <span class="dt">col_rename =</span> <span class="st">&quot;roll.max.15&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 2,531 × 13
##          date  open  high   low close    volume adjusted roll.min.5
##        &lt;date&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;
## 1  2007-01-03 86.29 86.58 81.90 83.80 309579900 10.90416         NA
## 2  2007-01-04 84.05 85.95 83.82 85.66 211815100 11.14619         NA
## 3  2007-01-05 85.77 86.20 84.40 85.05 208685400 11.06681         NA
## 4  2007-01-08 85.96 86.53 85.28 85.47 199276700 11.12147         NA
## 5  2007-01-09 86.45 92.98 85.15 92.57 837324600 12.04533   10.90416
## 6  2007-01-10 94.75 97.80 93.45 97.00 738220000 12.62176   11.06681
## 7  2007-01-11 95.94 96.78 95.10 95.80 360063200 12.46562   11.06681
## 8  2007-01-12 94.59 95.06 93.23 94.62 328172600 12.31207   11.12147
## 9  2007-01-16 95.68 97.25 95.45 97.10 311019100 12.63477   12.04533
## 10 2007-01-17 97.56 97.60 94.82 94.95 411565000 12.35501   12.31207
## # ... with 2,521 more rows, and 5 more variables: roll.min.10 &lt;dbl&gt;,
## #   roll.min.15 &lt;dbl&gt;, roll.max.5 &lt;dbl&gt;, roll.max.10 &lt;dbl&gt;,
## #   roll.max.15 &lt;dbl&gt;</code></pre>
<p>Note that the new column names were added using the <code>col_rename</code> argument. If this was left off, the column names are auto-generated from the <code>mutate_fun</code> name with a sequential suffix added, which is likely not descriptive enough for your needs.</p>
<p><a class="anchor" id="built-for-scale"></a></p>
</div>
</div>
</div>
<div id="designed-to-be-scaled-with-the-tidyverse" class="section level2">
<h2>Designed to be Scaled with the tidyverse</h2>
<p>All functions return data sets as <code>tibbles</code>, which allows for interaction within the <code>tidyverse</code>. This means we can:</p>
<ul>
<li>Use <code>dplyr</code> and <code>tidyr</code> to select, filter, nest/unnest, group_by, etc.</li>
<li>Use the pipe (<code>%&gt;%</code>) for chaining operations.</li>
<li>Seamlessly scale data retrieval and transformations/mutations using <code>purrr</code> to map functions or <code>dplyr</code> to combine <code>group_by</code> with <code>tq_mutate</code> or <code>tq_transform</code>.</li>
</ul>
<div id="getting-financial-data-for-multiple-stocks" class="section level4">
<h4>Getting Financial Data for Multiple Stocks</h4>
<p>A very basic example is retrieving the stock prices for multiple stocks. There are four primary ways to do this:</p>
<p><strong>Method 1: Map a character vector with multiple stock symbols</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;FB&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2016-01-01&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2017-01-01&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 756 × 8
##    symbol.x       date   open   high    low  close   volume  adjusted
##       &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1      AAPL 2016-01-04 102.61 105.37 102.00 105.35 67649400 103.05706
## 2      AAPL 2016-01-05 105.75 105.85 102.41 102.71 55791000 100.47452
## 3      AAPL 2016-01-06 100.56 102.37  99.87 100.70 68457400  98.50827
## 4      AAPL 2016-01-07  98.68 100.13  96.43  96.45 81094400  94.35077
## 5      AAPL 2016-01-08  98.55  99.11  96.76  96.96 70798000  94.84967
## 6      AAPL 2016-01-11  98.97  99.06  97.34  98.53 49739400  96.38550
## 7      AAPL 2016-01-12 100.55 100.69  98.84  99.96 49154200  97.78438
## 8      AAPL 2016-01-13 100.32 101.19  97.30  97.39 62439600  95.27031
## 9      AAPL 2016-01-14  97.96 100.48  95.74  99.52 63170100  97.35395
## 10     AAPL 2016-01-15  96.20  97.71  95.36  97.13 79010000  95.01597
## # ... with 746 more rows</code></pre>
<p>The output is a single level tibble with all or the stock prices in one tibble. The auto-generated column name is “symbol.x”, which can be pre-emptively renamed by giving the vector a name (e.g. <code>stocks &lt;- c(&quot;AAPL&quot;, &quot;GOOG&quot;, &quot;FB&quot;)</code>) and then piping to <code>tq_get</code>.</p>
<p><strong>Method 2: Map a tibble with stocks in first column</strong></p>
<p>First, obtain a tibble of stocks. The stock symbols must be in the first column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">symbols =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;JPM&quot;</span>, <span class="st">&quot;CVX&quot;</span>),
                     <span class="dt">industry =</span> <span class="kw">c</span>(<span class="st">&quot;Technology&quot;</span>, <span class="st">&quot;Financial&quot;</span>, <span class="st">&quot;Energy&quot;</span>))
stock_list</code></pre></div>
<pre><code>## # A tibble: 3 × 2
##   symbols   industry
##     &lt;chr&gt;      &lt;chr&gt;
## 1    AAPL Technology
## 2     JPM  Financial
## 3     CVX     Energy</code></pre>
<p>Second, send the stock list to <code>tq_get</code>. Notice how the symbol and industry columns are expanded the length of the stock prices.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>, <span class="dt">from =</span> <span class="st">&quot;2016-01-01&quot;</span>, <span class="dt">to =</span> <span class="st">&quot;2017-01-01&quot;</span>)</code></pre></div>
<pre><code>## # A tibble: 756 × 9
##    symbols   industry       date   open   high    low  close   volume
##      &lt;chr&gt;      &lt;chr&gt;     &lt;date&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;
## 1     AAPL Technology 2016-01-04 102.61 105.37 102.00 105.35 67649400
## 2     AAPL Technology 2016-01-05 105.75 105.85 102.41 102.71 55791000
## 3     AAPL Technology 2016-01-06 100.56 102.37  99.87 100.70 68457400
## 4     AAPL Technology 2016-01-07  98.68 100.13  96.43  96.45 81094400
## 5     AAPL Technology 2016-01-08  98.55  99.11  96.76  96.96 70798000
## 6     AAPL Technology 2016-01-11  98.97  99.06  97.34  98.53 49739400
## 7     AAPL Technology 2016-01-12 100.55 100.69  98.84  99.96 49154200
## 8     AAPL Technology 2016-01-13 100.32 101.19  97.30  97.39 62439600
## 9     AAPL Technology 2016-01-14  97.96 100.48  95.74  99.52 63170100
## 10    AAPL Technology 2016-01-15  96.20  97.71  95.36  97.13 79010000
## # ... with 746 more rows, and 1 more variables: adjusted &lt;dbl&gt;</code></pre>
<p><strong>Method 3: Use purrr to map a function</strong></p>
<p>This is the most flexible method. We can pipe a tibble of stock symbols to a mutation that maps the <code>tq_get(get = &quot;stock.prices&quot;)</code> function. The result is all of the stock prices in nested format.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tibble</span>(<span class="dt">symbol =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;AMZN&quot;</span>, <span class="st">&quot;FB&quot;</span>, <span class="st">&quot;AVGO&quot;</span>, <span class="st">&quot;SWKS&quot;</span>,<span class="st">&quot;NVDA&quot;</span>)) %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">stock.prices =</span> <span class="kw">map</span>(<span class="dt">.x =</span> symbol, ~<span class="st"> </span><span class="kw">tq_get</span>(.x, <span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)))</code></pre></div>
<pre><code>## # A tibble: 7 × 2
##   symbol         stock.prices
##    &lt;chr&gt;               &lt;list&gt;
## 1   AAPL &lt;tibble [2,531 × 7]&gt;
## 2   GOOG &lt;tibble [2,531 × 7]&gt;
## 3   AMZN &lt;tibble [2,531 × 7]&gt;
## 4     FB &lt;tibble [1,176 × 7]&gt;
## 5   AVGO &lt;tibble [1,878 × 7]&gt;
## 6   SWKS &lt;tibble [2,531 × 7]&gt;
## 7   NVDA &lt;tibble [2,531 × 7]&gt;</code></pre>
<p><strong>Method 4: Combine tq_get calls to stock index with stock prices</strong></p>
<p>This is a powerful extension of Method 2 that enables us to retrieve the stock prices, financials, key ratios, etc for <strong>every stock in an index</strong>. First, call <code>tq_get</code> using an stock index. Second, send the stock list to <code>tq_get</code> using stock prices. The workflow looks like this. <em>Note this can take several minutes depending on the size of the index, which is why it is not evaluated in the vignette.</em></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tq_get</span>(<span class="st">&quot;SP500&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;stock.index&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)</code></pre></div>
</div>
<div id="manipulating-financial-data-for-multiple-stocks" class="section level4">
<h4>Manipulating Financial Data for Multiple Stocks</h4>
<p>Once you get the data, you typically want to do something with it. You can easily do this at scale. Let’s get the yearly returns for multiple stocks using <code>tq_transform</code>. First, get the prices. Second, use <code>group_by</code> to group by stock symbol. Third, apply the transformation. We can do this in one easy workflow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;FB&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">group_by</span>(symbol.x) %&gt;%
<span class="st">    </span><span class="kw">tq_transform</span>(Ad, <span class="dt">transform_fun =</span> periodReturn, <span class="dt">period =</span> <span class="st">&quot;yearly&quot;</span>)</code></pre></div>
<pre><code>## Source: local data frame [28 x 3]
## Groups: symbol.x [3]
## 
##    symbol.x       date yearly.returns
##       &lt;chr&gt;     &lt;dttm&gt;          &lt;dbl&gt;
## 1      AAPL 2007-12-31     1.36372304
## 2      AAPL 2008-12-31    -0.56911347
## 3      AAPL 2009-12-31     1.46901003
## 4      AAPL 2010-12-31     0.53067909
## 5      AAPL 2011-12-30     0.25558032
## 6      AAPL 2012-12-31     0.32566899
## 7      AAPL 2013-12-31     0.08069481
## 8      AAPL 2014-12-31     0.40622503
## 9      AAPL 2015-12-31    -0.03013719
## 10     AAPL 2016-12-30     0.12480428
## # ... with 18 more rows</code></pre>
</div>
<div id="mapping-functions-with-purrr" class="section level4">
<h4>Mapping Functions with purrr</h4>
<p>Eventually you will want to begin modeling at scale. One of the coolest features of the <code>tidyverse</code> is the ability to map functions to nested tibbles using purrr. From “<a href="http://r4ds.had.co.nz/">R for Data Science</a>”, we can apply the same modeling workflow to financial analysis. Using a two step workflow:</p>
<ol style="list-style-type: decimal">
<li>Analyze a single stock</li>
<li>Scale to many stocks</li>
</ol>
<p>Let’s go through an example to illustrate. In our hypothetical situation, we want to compare the mean monthly log returns (MMLR).</p>
<div id="analyze-a-single-stock" class="section level5">
<h5>Analyze a Single Stock</h5>
<p>First, let’s come up with a function to help us collect log returns. The function below performs three operations internally. It first gets the stock prices using <code>tq_get()</code>. Then, it transforms the stock prices to period returns using <code>tq_transform()</code>. We add the <code>type = &quot;log&quot;</code> and <code>period = &quot;monthly&quot;</code> arguments to ensure we retrieve a tibble of monthly log returns. Last, we take the mean of the monthly returns to get MMLR.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_stock_analysis_fun &lt;-<span class="st"> </span>function(stock.symbol) {
    period.returns &lt;-<span class="st"> </span>stock.symbol %&gt;%
<span class="st">        </span><span class="kw">tq_get</span>(<span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>) %&gt;%
<span class="st">        </span><span class="kw">tq_transform</span>(<span class="dt">ohlc_fun =</span> Ad, <span class="dt">transform_fun =</span> periodReturn, 
                     <span class="dt">type =</span> <span class="st">&quot;log&quot;</span>, <span class="dt">period =</span> <span class="st">&quot;monthly&quot;</span>)
    <span class="kw">mean</span>(period.returns$monthly.returns)
}</code></pre></div>
<p>And, let’s test it out. We now have the mean monthly log returns over the past ten years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">my_stock_analysis_fun</span>(<span class="st">&quot;AAPL&quot;</span>)</code></pre></div>
<pre><code>## [1] 0.01982105</code></pre>
</div>
<div id="extrapolate-to-many-stocks" class="section level5">
<h5>Extrapolate to Many Stocks</h5>
<p>Now that we have one stock down, we can scale to many stocks. For brevity, we’ll randomly sample ten stocks from the S&amp;P500 with a call to <code>dplyr::sample_n()</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">100</span>)
stocks &lt;-<span class="st"> </span><span class="kw">tq_get</span>(<span class="st">&quot;SP500&quot;</span>, <span class="dt">get =</span> <span class="st">&quot;stock.index&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">sample_n</span>(<span class="dv">10</span>)
stocks</code></pre></div>
<pre><code>## # A tibble: 10 × 2
##    symbol            company
##     &lt;chr&gt;              &lt;chr&gt;
## 1     EMC                EMC
## 2    XRAY      DENTSPLY INTL
## 3     MNK   MALLINCKRODT PLC
## 4     AIG      AMERICAN INTL
## 5    INTC              INTEL
## 6     IVZ            INVESCO
## 7      SE     SPECTRA ENERGY
## 8    FLIR       FLIR SYSTEMS
## 9       L              LOEWS
## 10    CNP CENTERPOINT ENERGY</code></pre>
<p>We can now apply our analysis function to the stocks using <code>dplyr::mutate</code> and <code>purrr::map_dbl</code>. The <code>mutate()</code> function adds a column to our tibble, and the <code>map_dbl()</code> function maps our <code>my_stock_analysis_fun</code> to our tibble of stocks using the <code>symbol</code> column.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stocks &lt;-<span class="st"> </span>stocks %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">mmlr =</span> <span class="kw">map_dbl</span>(symbol, my_stock_analysis_fun)) %&gt;%
<span class="st">    </span><span class="kw">arrange</span>(<span class="kw">desc</span>(mmlr))
stocks</code></pre></div>
<pre><code>## # A tibble: 10 × 3
##    symbol            company         mmlr
##     &lt;chr&gt;              &lt;chr&gt;        &lt;dbl&gt;
## 1    INTC              INTEL  0.007502913
## 2     EMC                EMC  0.007208655
## 3     CNP CENTERPOINT ENERGY  0.007178644
## 4    FLIR       FLIR SYSTEMS  0.007036239
## 5      SE     SPECTRA ENERGY  0.006700684
## 6    XRAY      DENTSPLY INTL  0.005623011
## 7     IVZ            INVESCO  0.004337436
## 8       L              LOEWS  0.001448998
## 9     MNK   MALLINCKRODT PLC  0.000539013
## 10    AIG      AMERICAN INTL -0.023216192</code></pre>
<p>And, we’re done! We now have the MMLR for 10-years of stock data for 10 stocks. And, we can easily extend this to larger lists or stock indexes. For example, the entire S&amp;P500 could be analyzed removing the <code>sample_n()</code> following the call to <code>tq_get(&quot;SP500&quot;, get = &quot;stock.index&quot;)</code>.</p>
</div>
</div>
<div id="a-quick-note-on-scaling-with-tidyquant" class="section level4">
<h4>A Quick Note on Scaling with tidyquant</h4>
<p>Eventually you will run into a stock index, stock symbol, FRED data code, etc that cannot be retrieved. Possible reasons are:</p>
<ul>
<li>The website changes</li>
<li>An index becomes out of date</li>
<li>A company goes private</li>
<li>A stock ticker symbol changes</li>
<li>Yahoo / FRED just doesn’t like your stock symbol / FRED code</li>
</ul>
<p>This becomes painful when scaling if the functions return errors. So, the <code>tq_get()</code> function is designed to handle errors gracefully. What this means is a <code>NA</code> value is returned when an error is generated along with a gentle error warning. There are pros and cons to this approach that you may not agree with but I believe helps in the long run. Just be aware of what happens:</p>
<ul>
<li><p><strong>Pros</strong>: Long running scripts are not interrupted because of one error</p></li>
<li><p><strong>Cons</strong>: Errors flow downstream if not looking at warnings and not reviewing results</p></li>
</ul>
<p><strong>With <code>tq_get()</code>, Bad Apples Fail Gracefully</strong>:</p>
<p>Let’s see an example when mapping to <code>tq_get()</code> to a long list of stocks with one <code>BAD APPLE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list_with_one_bad_apple &lt;-<span class="st"> </span><span class="kw">tibble</span>( 
    <span class="dt">symbol =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;AMZN&quot;</span>, <span class="st">&quot;FB&quot;</span>, <span class="st">&quot;BAD APPLE&quot;</span>,
               <span class="st">&quot;AVGO&quot;</span>, <span class="st">&quot;SWKS&quot;</span>,<span class="st">&quot;NVDA&quot;</span>, <span class="st">&quot;V&quot;</span>, <span class="st">&quot;MA&quot;</span>)
)
stock_list_with_one_bad_apple &lt;-<span class="st"> </span>stock_list_with_one_bad_apple %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">stock.prices =</span> <span class="kw">map</span>(<span class="dt">.x =</span> symbol, ~<span class="st"> </span><span class="kw">tq_get</span>(<span class="dt">x =</span> .x, <span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)))</code></pre></div>
<pre><code>## Warning in value[[3L]](cond): Error at stock symbol BAD APPLE during call
## to quantmod::getSymbols.</code></pre>
<p>We get warned that there was an issue in the operation. With that said, we still get the full list of stocks.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list_with_one_bad_apple</code></pre></div>
<pre><code>## # A tibble: 10 × 2
##       symbol         stock.prices
##        &lt;chr&gt;               &lt;list&gt;
## 1       AAPL &lt;tibble [2,531 × 7]&gt;
## 2       GOOG &lt;tibble [2,531 × 7]&gt;
## 3       AMZN &lt;tibble [2,531 × 7]&gt;
## 4         FB &lt;tibble [1,176 × 7]&gt;
## 5  BAD APPLE            &lt;lgl [1]&gt;
## 6       AVGO &lt;tibble [1,878 × 7]&gt;
## 7       SWKS &lt;tibble [2,531 × 7]&gt;
## 8       NVDA &lt;tibble [2,531 × 7]&gt;
## 9          V &lt;tibble [2,227 × 7]&gt;
## 10        MA &lt;tibble [2,531 × 7]&gt;</code></pre>
<p>Say hypothetically we didn’t recognize the error message. An error shows up during the next operation. As an example, we’ll attempt to get yearly period returns using <code>tq_transform</code>. The operation is wrapped in a <code>tryCatch()</code> statement to enable printing the error message.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">tryCatch</span>({
    stock_list_with_one_bad_apple %&gt;%
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">annual.returns =</span> <span class="kw">map</span>(<span class="dt">.x =</span> stock.prices, 
                                ~<span class="st"> </span><span class="kw">tq_transform</span>(<span class="dt">x =</span> .x,
                                               <span class="dt">ohlc_fun =</span> Ad, 
                                               <span class="dt">transform_fun =</span> periodReturn, 
                                               <span class="dt">period =</span> <span class="st">&quot;yearly&quot;</span>)
                                )
           )
}, <span class="dt">error =</span> function(e) {
    <span class="kw">print</span>(e)
})</code></pre></div>
<pre><code>## &lt;Rcpp::eval_error in eval(substitute(expr), envir, enclos): argument &quot;data&quot; is missing, with no default&gt;</code></pre>
<p>The operation grinds to a hault because the <code>BAD APPLE</code> tried to send its value for stock.prices of <code>NA</code> to the <code>tq_transform()</code> function. The error message tells us that <code>data</code> is not a <code>tibble</code> or <code>data.frame</code>.</p>
<p>The rationale behind the error handling approach is that long-running scripts should not fail during minor issues. For example, if you have a list of 3000 stocks and the 3000th is bad, the program could take 20+ minutes to fail. This is disheartening. We allow <code>tq_get()</code> to continue to fetch data even if an error is encountered. Failure occurs during <code>tq_transform()</code> and <code>tq_mutate()</code> to prevent the error from getting too far downstream.</p>
<p><strong>Break Up Get Operations from Mutate / Transform Operations</strong>:</p>
<p>Recognizing how <code>tq_get()</code> works (and gracefully fails), we can adjust our workflow. It’s a good idea to collect stock information in one independent step, review any warnings / errors, and remove “bad apples” if present before moving on to any transformations or mutations.</p>
<p>Here’s an example of a good workflow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stock_list_with_one_bad_apple &lt;-<span class="st"> </span><span class="kw">tibble</span>( 
    <span class="dt">symbol =</span> <span class="kw">c</span>(<span class="st">&quot;AAPL&quot;</span>, <span class="st">&quot;GOOG&quot;</span>, <span class="st">&quot;AMZN&quot;</span>, <span class="st">&quot;FB&quot;</span>, <span class="st">&quot;BAD APPLE&quot;</span>,
               <span class="st">&quot;AVGO&quot;</span>, <span class="st">&quot;SWKS&quot;</span>,<span class="st">&quot;NVDA&quot;</span>, <span class="st">&quot;V&quot;</span>, <span class="st">&quot;MA&quot;</span>)
    ) %&gt;%
<span class="st">    </span><span class="co"># Step 1: Get stock prices</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">stock.prices =</span> <span class="kw">map</span>(<span class="dt">.x =</span> symbol, ~<span class="st"> </span><span class="kw">tq_get</span>(<span class="dt">x =</span> .x, <span class="dt">get =</span> <span class="st">&quot;stock.prices&quot;</span>)),
           <span class="dt">class =</span> <span class="kw">map_chr</span>(<span class="dt">.x =</span> stock.prices, ~<span class="st"> </span><span class="kw">class</span>(.x)[[<span class="dv">1</span>]])) %&gt;%
<span class="st">    </span><span class="co"># Step 2: Filter out errors; errors have a class of &quot;logical&quot;</span>
<span class="st">    </span><span class="kw">filter</span>(class !=<span class="st"> &quot;logical&quot;</span>) %&gt;%
<span class="st">    </span><span class="kw">select</span>(-class) %&gt;%
<span class="st">    </span><span class="co"># Step 3: Perform period returns</span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">annual.returns =</span> <span class="kw">map</span>(<span class="dt">.x =</span> stock.prices, 
                                ~<span class="st"> </span><span class="kw">tq_transform</span>(<span class="dt">data =</span> .x,
                                               <span class="dt">ohlc_fun =</span> Ad, 
                                               <span class="dt">transform_fun =</span> periodReturn, 
                                               <span class="dt">period =</span> <span class="st">&quot;yearly&quot;</span>)
                                )
           )
stock_list_with_one_bad_apple</code></pre></div>
<pre><code>## # A tibble: 9 × 3
##   symbol         stock.prices    annual.returns
##    &lt;chr&gt;               &lt;list&gt;            &lt;list&gt;
## 1   AAPL &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;
## 2   GOOG &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;
## 3   AMZN &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;
## 4     FB &lt;tibble [1,176 × 7]&gt;  &lt;tibble [6 × 2]&gt;
## 5   AVGO &lt;tibble [1,878 × 7]&gt;  &lt;tibble [9 × 2]&gt;
## 6   SWKS &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;
## 7   NVDA &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;
## 8      V &lt;tibble [2,227 × 7]&gt; &lt;tibble [10 × 2]&gt;
## 9     MA &lt;tibble [2,531 × 7]&gt; &lt;tibble [11 × 2]&gt;</code></pre>
</div>
</div>
</div>
<div id="recap" class="section level1">
<h1>Recap</h1>
<p>Hopefully now you see how <code>tidyquant</code> helps to integrate the best quantitative financial analysis packages with the <code>tidyverse</code>. With a few, easy-to-use core functions, you can efficiently leverage the quantitative power of <code>xts</code> and <code>zoo</code>, <code>quantmod</code> and <code>TTR</code> with the data management infrastructure and scale-ability of the <code>tidyverse</code>.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
